<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POP32i Simulator: AI Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&family=Source+Code+Pro:wght@400;700&display=swap');
        
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f3f4f6;
            height: 100vh;
            overflow: hidden;
        }

        .code-font {
            font-family: 'Source Code Pro', monospace;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }

        .canvas-bg {
            background-color: #e5e7eb;
            cursor: grab;
        }
        .canvas-bg:active {
            cursor: grabbing;
        }
        
        optgroup { font-weight: bold; color: #fbbf24; background-color: #3730a3; }
        option { color: white; background-color: #4338ca; }

        /* AI Chat Bubble Animation */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        .ai-float { animation: float 3s ease-in-out infinite; }
    </style>
</head>
<body class="flex flex-col h-screen text-gray-800">

    <!-- Header -->
    <header class="bg-indigo-900 text-white p-3 shadow-md flex justify-between items-center shrink-0 z-20 border-b border-indigo-700">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center text-indigo-900 font-bold text-xl shadow-lg">
                <i class="fas fa-robot"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-yellow-400">POP32i AI Simulator</h1>
                <p class="text-xs text-indigo-200">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI</p>
            </div>
        </div>
        <div class="flex gap-2 items-center">
            <div class="flex flex-col items-end mr-2">
                <label class="text-[10px] uppercase text-indigo-200 font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à (Mission)</label>
                <select id="missionSelect" class="bg-indigo-800 text-yellow-300 border border-indigo-500 rounded px-3 py-1 text-sm focus:outline-none w-72 font-medium shadow-inner">
                    <option value="free">üõ†Ô∏è ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏¥‡∏™‡∏£‡∏∞ (Free Run)</option>
                    <optgroup label="Beginner (‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô 1-4)">
                        <option value="lv1">‡∏î‡πà‡∏≤‡∏ô 1: ‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏ß‡∏¥‡∏®‡∏ß‡∏∞</option>
                        <option value="lv2">‡∏î‡πà‡∏≤‡∏ô 2: ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏•‡πÑ‡∏õ‡∏ß‡∏¥‡∏ó‡∏¢‡πå</option>
                        <option value="lv3">‡∏î‡πà‡∏≤‡∏ô 3: ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
                        <option value="lv4">‡∏î‡πà‡∏≤‡∏ô 4: ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏Ç‡∏ß‡∏≤‡πÑ‡∏õ‡πÄ‡∏Å‡∏©‡∏ï‡∏£</option>
                    </optgroup>
                    <optgroup label="Intermediate (‡∏Ñ‡∏µ‡∏ö‡∏Ç‡∏≠‡∏á 5-10)">
                        <option value="lv5">‡∏î‡πà‡∏≤‡∏ô 5: ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏î‡πà‡∏ß‡∏ô (Pick & Place)</option>
                        <option value="lv6">‡∏î‡πà‡∏≤‡∏ô 6: ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏ï‡∏∂‡∏Å</option>
                        <option value="lv7">‡∏î‡πà‡∏≤‡∏ô 7: ‡πÄ‡∏î‡∏¥‡∏ô‡∏ß‡∏ô Loop ‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°</option>
                        <option value="lv8">‡∏î‡πà‡∏≤‡∏ô 8: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏û‡∏≠‡∏¢‡∏ï‡πå (Checkpoint)</option>
                        <option value="lv9">‡∏î‡πà‡∏≤‡∏ô 9: ‡∏ñ‡∏≠‡∏¢‡∏à‡∏≠‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ã‡∏≠‡∏á</option>
                        <option value="lv10">‡∏î‡πà‡∏≤‡∏ô 10: ‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ (Full)</option>
                    </optgroup>
                    <optgroup label="Expert (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏ó‡∏û 11-20)">
                        <option value="lv11">‡∏î‡πà‡∏≤‡∏ô 11: ‡∏ã‡∏¥‡∏Å‡πÅ‡∏ã‡∏Å‡∏´‡∏•‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á</option>
                        <option value="lv12">‡∏î‡πà‡∏≤‡∏ô 12: ‡∏Å‡∏•‡∏±‡∏ö‡∏£‡∏ñ‡∏ï‡∏±‡∏ß U</option>
                        <option value="lv13">‡∏î‡πà‡∏≤‡∏ô 13: ‡πÄ‡∏•‡∏Ç 8 ‡∏°‡∏´‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå</option>
                        <option value="lv14">‡∏î‡πà‡∏≤‡∏ô 14: ‡πÄ‡∏î‡∏¥‡∏ô‡∏ß‡∏ô‡∏Å‡πâ‡∏ô‡∏´‡∏≠‡∏¢</option>
                        <option value="lv15">‡∏î‡πà‡∏≤‡∏ô 15: ‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏¢‡∏≤‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≠‡∏î</option>
                        <option value="lv16">‡∏î‡πà‡∏≤‡∏ô 16: ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á 3 ‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á</option>
                        <option value="lv17">‡∏î‡πà‡∏≤‡∏ô 17: ‡∏ß‡∏¥‡πà‡∏á‡∏£‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡∏≠‡∏á</option>
                        <option value="lv18">‡∏î‡πà‡∏≤‡∏ô 18: ‡∏™‡∏•‡∏±‡∏ö‡∏ü‡∏±‡∏ô‡∏õ‡∏•‡∏≤</option>
                        <option value="lv19">‡∏î‡πà‡∏≤‡∏ô 19: ‡∏´‡∏°‡∏∏‡∏ô‡∏ï‡∏±‡∏ß 360 ‡πÇ‡∏ä‡∏ß‡πå‡∏û‡∏≤‡∏ß</option>
                        <option value="lv20">‡∏î‡πà‡∏≤‡∏ô 20: THE FINAL EXAM</option>
                    </optgroup>
                </select>
            </div>
            <button onclick="openAI()" class="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 px-4 py-2 rounded-full text-sm transition h-full text-white shadow-lg flex items-center gap-2 ai-float border border-cyan-300">
                <i class="fas fa-sparkles"></i> AI Helper
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Left: Code Editor -->
        <div class="w-1/3 bg-gray-900 flex flex-col border-r border-gray-700 relative z-10">
            <div class="bg-gray-800 text-gray-300 px-4 py-2 text-xs font-mono flex justify-between items-center border-b border-gray-700">
                <span>main.cpp</span>
                <span id="statusIndicator" class="text-yellow-500"><i class="fas fa-circle text-[8px] mr-1"></i>Ready</span>
            </div>
            
            <div class="relative flex-1 overflow-hidden">
                <textarea id="codeEditor" class="w-full h-full bg-gray-900 text-green-400 code-font p-4 outline-none resize-none text-sm leading-relaxed" spellcheck="false" placeholder="// ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
            </div>

            <!-- Editor Controls -->
            <div class="p-4 bg-gray-800 border-t border-gray-700 flex gap-2">
                <button onclick="runSimulation()" id="runBtn" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-2 rounded font-semibold transition flex items-center justify-center gap-2 shadow-lg shadow-green-900/50">
                    <i class="fas fa-play"></i> Upload & Run
                </button>
                <button onclick="resetSimulation()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 rounded font-semibold transition shadow-lg">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
        </div>

        <!-- Right: Simulation Area -->
        <div class="flex-1 flex flex-col relative bg-gray-100 overflow-hidden">
            
            <!-- HUD / Toolbar -->
            <div class="absolute top-4 left-4 z-10 flex gap-2 flex-wrap pointer-events-none">
                <div class="bg-white/90 backdrop-blur shadow-lg rounded-lg p-3 w-48 border border-gray-200 pointer-events-auto">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-1">OLED Display (128x64)</div>
                    <div id="oledScreen" class="bg-black text-cyan-400 font-mono text-xs p-2 h-16 rounded overflow-hidden leading-tight whitespace-pre-wrap">
                        POP32i Ready...
                    </div>
                </div>
                
                <div class="bg-white/90 backdrop-blur shadow-lg rounded-lg p-3 border border-gray-200 flex flex-col justify-center min-w-[100px] pointer-events-auto">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-1">Status</div>
                    <div class="text-xs space-y-1">
                        <div><span class="font-bold text-gray-700">M1(L):</span> <span id="motorL" class="text-blue-600">0</span> <span class="font-bold text-gray-700 ml-1">M2(R):</span> <span id="motorR" class="text-blue-600">0</span></div>
                        <div><span class="font-bold text-gray-700">Servo 1:</span> <span id="servoVal" class="text-purple-600">90¬∞</span></div>
                    </div>
                </div>
            </div>

            <!-- Zoom Controls -->
            <div class="absolute bottom-6 right-6 z-10 flex flex-col gap-2">
                <button onclick="zoomIn()" class="w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center text-gray-600 hover:text-indigo-600 hover:bg-gray-50 transition border border-gray-200 font-bold text-xl">
                    <i class="fas fa-plus"></i>
                </button>
                <button onclick="resetCamera()" class="w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center text-gray-600 hover:text-indigo-600 hover:bg-gray-50 transition border border-gray-200 text-sm" title="Fit Screen">
                    <i class="fas fa-compress"></i>
                </button>
                <button onclick="zoomOut()" class="w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center text-gray-600 hover:text-indigo-600 hover:bg-gray-50 transition border border-gray-200 font-bold text-xl">
                    <i class="fas fa-minus"></i>
                </button>
            </div>

            <!-- Canvas -->
            <canvas id="simCanvas" class="w-full h-full canvas-bg block"></canvas>

            <!-- Mission Objective Popup -->
            <div id="missionBox" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-white/95 backdrop-blur shadow-xl rounded-full px-6 py-3 border border-indigo-200 hidden items-center gap-3 animate-bounce z-20 pointer-events-none">
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                    <i class="fas fa-flag-checkered"></i>
                </div>
                <div>
                    <div class="text-xs text-gray-500 font-bold uppercase">Current Mission</div>
                    <span id="missionText" class="text-sm font-semibold text-gray-800">Mission text here</span>
                </div>
            </div>

            <!-- Success Overlay -->
            <div id="successOverlay" class="absolute inset-0 bg-black/80 hidden flex-col items-center justify-center text-white z-50 backdrop-blur-sm">
                <div class="text-6xl text-yellow-400 mb-4 animate-pulse"><i class="fas fa-star"></i></div>
                <h2 class="text-4xl font-bold mb-2">Mission Complete!</h2>
                <p class="text-gray-300 mb-8 text-lg">‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! ‡∏ú‡πà‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
                <div class="flex gap-4">
                    <button onclick="closeSuccess()" class="bg-gray-600 hover:bg-gray-500 px-6 py-2 rounded-full font-bold transition">
                        ‡πÄ‡∏•‡πà‡∏ô‡∏ã‡πâ‡∏≥
                    </button>
                    <button onclick="nextLevel()" class="bg-indigo-600 hover:bg-indigo-500 px-8 py-2 rounded-full font-bold transition flex items-center gap-2 shadow-lg hover:shadow-indigo-500/50">
                        ‡∏î‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Modal -->
    <div id="aiModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden border border-cyan-200">
            <div class="bg-gradient-to-r from-indigo-900 to-indigo-800 p-4 flex items-center justify-between border-b border-indigo-700">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-cyan-400 rounded-full flex items-center justify-center text-indigo-900 font-bold text-xl shadow-inner animate-pulse">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-white">POP-AI Assistant</h3>
                        <p class="text-xs text-cyan-200">‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ (Online)</p>
                    </div>
                </div>
                <button onclick="closeAI()" class="text-gray-400 hover:text-white transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 bg-gray-50 min-h-[200px]">
                <div id="aiChatContent" class="space-y-4">
                    <!-- Dynamic Content -->
                    <p class="text-gray-700 bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                        ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡πà‡∏≤‡∏ô <strong><span id="aiLevelName"></span></strong> ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?
                    </p>
                </div>
            </div>

            <div class="p-4 bg-white border-t border-gray-100 grid grid-cols-1 gap-2">
                <button onclick="aiGetHint()" class="flex items-center justify-center gap-2 w-full bg-yellow-100 hover:bg-yellow-200 text-yellow-800 py-3 rounded-xl font-semibold transition border border-yellow-200">
                    <i class="fas fa-lightbulb text-yellow-500"></i> ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ (Hint)
                </button>
                <button onclick="aiCheckCode()" class="flex items-center justify-center gap-2 w-full bg-blue-100 hover:bg-blue-200 text-blue-800 py-3 rounded-xl font-semibold transition border border-blue-200">
                    <i class="fas fa-search-code text-blue-500"></i> ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢
                </button>
                <button onclick="aiRevealSolution()" class="flex items-center justify-center gap-2 w-full bg-red-50 hover:bg-red-100 text-red-800 py-2 rounded-xl text-sm transition border border-red-100 mt-2">
                    <i class="fas fa-lock-open"></i> ‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ (‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢)
                </button>
            </div>
        </div>
    </div>

    <!-- Audio -->
    <audio id="beepSound" src="data:audio/wav;base64,UklGRl9vT1dAVXphcnQAAAAAAAAAAAAAAABwY20gAAAAAGAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="></audio>

    <script>
        // --- Globals ---
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const editor = document.getElementById('codeEditor');
        const oled = document.getElementById('oledScreen');
        const motorLDisp = document.getElementById('motorL');
        const motorRDisp = document.getElementById('motorR');
        const servoDisp = document.getElementById('servoVal');
        const runBtn = document.getElementById('runBtn');
        const statusIndicator = document.getElementById('statusIndicator');

        // State
        let isRunning = false;
        let animationFrame;
        let commandQueue = [];
        let currentCommandIndex = 0;
        let commandStartTime = 0;
        let lastTimestamp = 0;

        // Camera & Interaction
        const WORLD_W = 2400;
        const WORLD_H = 1800;
        let camera = { x: 0, y: 0, scale: 0.5 };
        let isDragging = false;
        let lastMouse = { x: 0, y: 0 };

        // Robot
        const ROBOT_SIZE = 40;
        const ROBOT_COLOR = '#4F46E5'; 
        let robot = {
            x: 0, y: 0, angle: 0,
            speedL: 0, speedR: 0,
            servoAngle: 90, holdingObject: null
        };

        // Environment
        let currentLevel = 'lv1';
        let cans = [];
        let targetZones = []; 
        let checkpoints = []; 
        let currentCheckpointIndex = 0;

        // --- Level Data (Store Solutions for AI) ---
        const levelData = {
            'free': { name: "‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏¥‡∏™‡∏£‡∏∞", hint: "‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á FD, BK, SL, SR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏î‡∏π‡∏™‡∏¥‡∏Ñ‡∏£‡∏±‡∏ö", code: "// ‡∏•‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏•‡πà‡∏ô‡πÜ ‡∏î‡∏π‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö\nFD(50);\ndelay(1000);\nAO();" },
            'lv1': { 
                name: "‡∏î‡πà‡∏≤‡∏ô 1: ‡πÑ‡∏õ‡∏ß‡∏¥‡∏®‡∏ß‡∏∞", 
                hint: "‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏ï‡∏∂‡∏Å‡∏ß‡∏¥‡∏®‡∏ß‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 3.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢", 
                code: "FD(50); delay(3500);\nSL(40); delay(1200);\nFD(50); delay(3000);\nAO();" 
            },
            'lv2': { 
                name: "‡∏î‡πà‡∏≤‡∏ô 2: ‡πÑ‡∏õ‡∏ß‡∏¥‡∏ó‡∏¢‡πå", 
                hint: "‡∏ó‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏¢‡∏≤‡∏ß‡πÜ ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤ delay ‡∏î‡∏π‡∏™‡∏¥", 
                code: "FD(50); delay(5000);\nAO();" 
            },
            'lv3': { name: "‡∏î‡πà‡∏≤‡∏ô 3: ‡πÑ‡∏õ‡πÅ‡∏û‡∏ó‡∏¢‡πå", hint: "‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤ 2 ‡∏ß‡∏¥ -> ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢ -> ‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≠", code: "FD(50); delay(2000);\nSL(50); delay(1000);\nFD(50); delay(3000);\nAO();" },
            'lv4': { name: "‡∏î‡πà‡∏≤‡∏ô 4: ‡πÑ‡∏õ‡πÄ‡∏Å‡∏©‡∏ï‡∏£", hint: "‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏î‡πà‡∏≤‡∏ô 2 ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏Ç‡∏ß‡∏≤ (SR) ‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö", code: "FD(50); delay(5000);\nSR(50); delay(1000);\nFD(50); delay(3000);\nAO();" },
            'lv5': { name: "‡∏î‡πà‡∏≤‡∏ô 5: ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏î‡πà‡∏ß‡∏ô", hint: "‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á servo(1, 20) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏µ‡∏ö ‡πÅ‡∏•‡∏∞ servo(1, 90) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á", code: "servo(1, 90);\nFD(30); delay(800); AO();\nservo(1, 20); delay(500);\nFD(50); delay(3000);\nSL(40); delay(1200);\nFD(50); delay(3000);\nAO();\nservo(1, 90);" },
            'lv6': { name: "‡∏î‡πà‡∏≤‡∏ô 6: ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á", hint: "‡∏Ñ‡∏µ‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á (BK) ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö", code: "servo(1, 90);\nFD(30); delay(800); AO();\nservo(1, 20); delay(500);\nBK(40); delay(1500);\nSL(50); delay(1000);\nFD(50); delay(3000);\nAO();" },
            'lv7': { name: "‡∏î‡πà‡∏≤‡∏ô 7: Loop ‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°", hint: "‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤-‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥ 4 ‡∏£‡∏≠‡∏ö", code: "FD(50); delay(4000);\nSL(50); delay(1000);\nFD(40); delay(2000);\nSL(50); delay(1000);\nFD(50); delay(4000);\nSL(50); delay(1000);\nFD(40); delay(2000);\nAO();" },
            'lv8': { name: "‡∏î‡πà‡∏≤‡∏ô 8: Checkpoint", hint: "‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏∏‡∏î Checkpoint ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡∏¢", code: "FD(40); delay(1500);\nSR(50); delay(1000);\nFD(50); delay(4000);\nAO();" },
            'lv9': { name: "‡∏î‡πà‡∏≤‡∏ô 9: ‡∏ñ‡∏≠‡∏¢‡∏à‡∏≠‡∏î", hint: "‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏ï‡∏±‡πâ‡∏á‡∏•‡∏≥ ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á (BK) ‡∏¢‡∏≤‡∏ß‡πÜ", code: "FD(30); delay(1500);\nSL(50); delay(1000);\nBK(30); delay(3000);\nAO();" },
            'lv10': { 
                name: "‡∏î‡πà‡∏≤‡∏ô 10: Full Mission", 
                hint: "‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á! 1.‡πÑ‡∏õ‡∏£‡∏±‡∏ö(‡∏ß‡∏¥‡∏®‡∏ß‡∏∞) -> 2.‡πÑ‡∏õ‡∏™‡πà‡∏á(‡∏ß‡∏¥‡∏ó‡∏¢‡πå) -> 3.‡πÑ‡∏õ‡∏£‡∏±‡∏ö(‡πÄ‡∏Å‡∏©‡∏ï‡∏£) -> 4.‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏à‡∏≠‡∏î", 
                code: `// Pick Eng
FD(50); delay(3500);
SL(50); delay(800); FD(40); delay(1500); AO();
servo(1, 90); delay(500); FD(20); delay(500); AO(); servo(1, 20); delay(500);

// Drop Sci
BK(40); delay(2000); SR(50); delay(800);
FD(50); delay(2000); AO();
SL(50); delay(800); FD(30); delay(1000); AO();
servo(1, 90); delay(500); BK(30); delay(1000);

// Pick Agri
SR(50); delay(800); FD(50); delay(3000); AO();
SL(50); delay(800); FD(30); delay(1000); AO(); servo(1, 20); delay(500);

// Finish
BK(30); delay(1000); SL(50); delay(800);
FD(50); delay(4000); AO(); servo(1, 90);` 
            },
            // Expert hints mostly
            'lv11': { name: "‡∏î‡πà‡∏≤‡∏ô 11: Slalom", hint: "‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤-‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ ‡∏Ñ‡∏£‡∏±‡∏ö", code: "FD(50); delay(1000);\nSL(40); delay(500);\nFD(50); delay(1000);\nSR(40); delay(500);\nFD(50); delay(1000);\nSL(40); delay(500);\nFD(50); delay(1000);\nSR(40); delay(500);\nFD(50); delay(1500);\nAO();" },
            'lv12': { name: "‡∏î‡πà‡∏≤‡∏ô 12: U-Turn", hint: "‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß 90 ‡∏≠‡∏á‡∏®‡∏≤ ‡∏™‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö (SL + SL)", code: "FD(50); delay(2000);\nSL(60); delay(800);\nFD(30); delay(1000);\nSL(60); delay(800);\nFD(50); delay(2000);\nAO();" },
            'lv13': { name: "‡∏î‡πà‡∏≤‡∏ô 13: Figure 8", hint: "‡∏ß‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ 1 ‡∏£‡∏≠‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏ô‡∏Ç‡∏ß‡∏≤ 1 ‡∏£‡∏≠‡∏ö", code: "FD(50); delay(2000);\nSL(50); delay(1200);\nFD(40); delay(1500);\nSL(50); delay(1200);\nFD(50); delay(2000);\nSR(50); delay(1200);\nFD(40); delay(1500);\nSR(50); delay(1200);\nAO();" },
            'lv14': { name: "‡∏î‡πà‡∏≤‡∏ô 14: Spiral", hint: "‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß ‡πÅ‡∏ï‡πà‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ", code: "FD(60); delay(3000); SL(50); delay(800);\nFD(50); delay(2500); SL(50); delay(800);\nFD(40); delay(2000); SL(50); delay(800);\nFD(30); delay(1500); SL(50); delay(800);\nAO();" },
            'lv15': { name: "‡∏î‡πà‡∏≤‡∏ô 15: Long Reverse", hint: "‡πÉ‡∏ä‡πâ‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏´‡∏°‡∏∏‡∏ô‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡∏ã‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô motor(1, -30))", code: "BK(50); delay(4000);\nmotor(1, -30); motor(2, -60); delay(1500);\nBK(30); delay(1000);\nAO();" },
            'lv16': { name: "‡∏î‡πà‡∏≤‡∏ô 16: Multi-Drop", hint: "‡∏Ñ‡∏µ‡∏ö -> ‡∏ß‡∏≤‡∏á -> ‡πÑ‡∏õ‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà -> ‡∏Ñ‡∏µ‡∏ö", code: "servo(1, 90); FD(30); delay(500); AO(); servo(1, 20); delay(500);\nFD(50); delay(2000); AO(); servo(1, 90); delay(500); BK(20); delay(500);\nSR(50); delay(800); FD(50); delay(2000); AO();\nSL(50); delay(800); FD(40); delay(1500); AO();" },
            'lv17': { name: "‡∏î‡πà‡∏≤‡∏ô 17: Perimeter", hint: "‡πÄ‡∏î‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡∏Å‡∏£‡∏≠‡∏ö‡∏ô‡∏≠‡∏Å‡∏™‡∏∏‡∏î ‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏î‡∏µ‡πÜ", code: "FD(80); delay(4000);\nSL(50); delay(900);\nFD(80); delay(3000);\nSL(50); delay(900);\nFD(80); delay(4000);\nSL(50); delay(900);\nFD(80); delay(3000);\nAO();" },
            'lv18': { name: "‡∏î‡πà‡∏≤‡∏ô 18: Staircase", hint: "‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏Ç‡∏ß‡∏≤-‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢ ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏±‡∏ô‡πÑ‡∏î", code: "FD(40); delay(1000); SR(50); delay(800);\nFD(40); delay(1000); SL(50); delay(800);\nFD(40); delay(1000); SR(50); delay(800);\nFD(40); delay(1000); SL(50); delay(800);\nAO();" },
            'lv19': { name: "‡∏î‡πà‡∏≤‡∏ô 19: 360 Spin", hint: "‡∏´‡∏°‡∏∏‡∏ô‡∏•‡πâ‡∏≠‡∏™‡∏ß‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏±‡∏ô (‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå 1 ‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤, ‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå 2 ‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á)", code: "FD(50); delay(2000);\nmotor(1, 60); motor(2, -60); delay(2500);\nFD(50); delay(2000);\nAO();" },
            'lv20': { name: "‡∏î‡πà‡∏≤‡∏ô 20: FINAL", hint: "‡∏á‡∏±‡∏î‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏ó‡πà‡∏≤‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡∏ö! ‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡∏Ñ‡∏µ‡∏ö ‡∏ñ‡∏≠‡∏¢‡∏à‡∏≠‡∏î", code: "FD(60); delay(2000);\nSL(50); delay(800);\nFD(40); delay(1500);\nmotor(1, -40); motor(2, -20); delay(1500);\nBK(30); delay(1000);\nFD(100); delay(1500);\nAO();" }
        };

        // --- Core Functions ---
        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            draw();
        }
        window.addEventListener('resize', resizeCanvas);

        function resetCamera() {
            camera.x = WORLD_W / 2;
            camera.y = WORLD_H / 2;
            const scaleX = canvas.width / (WORLD_W + 100);
            const scaleY = canvas.height / (WORLD_H + 100);
            camera.scale = Math.min(scaleX, scaleY, 0.5);
            draw();
        }

        function zoomIn() { camera.scale *= 1.2; draw(); }
        function zoomOut() { camera.scale /= 1.2; draw(); }

        canvas.addEventListener('mousedown', e => {
            isDragging = true;
            lastMouse = { x: e.clientX, y: e.clientY };
        });

        window.addEventListener('mouseup', () => isDragging = false);

        canvas.addEventListener('mousemove', e => {
            if (isDragging) {
                const dx = e.clientX - lastMouse.x;
                const dy = e.clientY - lastMouse.y;
                camera.x -= dx / camera.scale;
                camera.y -= dy / camera.scale;
                lastMouse = { x: e.clientX, y: e.clientY };
                draw();
            }
        });

        canvas.addEventListener('wheel', e => {
            e.preventDefault();
            const zoomSpeed = 0.1;
            const newScale = camera.scale * (1 - Math.sign(e.deltaY) * zoomSpeed);
            if (newScale > 0.1 && newScale < 5.0) {
                camera.scale = newScale;
                draw();
            }
        }, { passive: false });

        function resetScenario() {
            robot.speedL = 0; robot.speedR = 0;
            robot.servoAngle = 90; robot.holdingObject = null;
            
            let startX = WORLD_W * 0.5;
            let startY = WORLD_H * 0.95;
            let startAngle = -Math.PI / 2;

            cans = [];
            targetZones = [];
            checkpoints = [];
            currentCheckpointIndex = 0;

            const w = WORLD_W;
            const h = WORLD_H;

            const locEng = { x: w*0.15, y: h*0.2, w: w*0.2, h: h*0.2, label: "Eng" };
            const locSci = { x: w*0.48, y: h*0.15, w: w*0.2, h: h*0.2, label: "Sci" };
            const locMed = { x: w*0.45, y: h*0.75, w: w*0.2, h: h*0.15, label: "Med" };
            const locAgri = { x: w*0.82, y: h*0.2, w: w*0.2, h: h*0.2, label: "Agri" };
            const locParking = { x: w*0.85, y: h*0.85, w: 200, h: 250, label: "Park" };

            // ... (Same Level Logic as before, just compact) ...
             switch(currentLevel) {
                case 'lv1': targetZones.push({ ...locEng, type: 'stop', active: true }); break;
                case 'lv2': targetZones.push({ ...locSci, type: 'stop', active: true }); break;
                case 'lv3': targetZones.push({ ...locMed, type: 'stop', active: true }); break;
                case 'lv4': targetZones.push({ ...locAgri, type: 'stop', active: true }); break;
                case 'lv5': 
                    cans.push({id: 1, x: startX, y: startY - 150, color: 'orange', radius: 15, grabbed: false});
                    targetZones.push({ ...locEng, type: 'drop', active: true });
                    break;
                case 'lv6': 
                    startX = locSci.x; startY = locSci.y + 150; startAngle = -Math.PI/2;
                    cans.push({id: 1, x: locSci.x, y: locSci.y, color: '#3b82f6', radius: 15, grabbed: false});
                    targetZones.push({ ...locMed, type: 'drop', active: true });
                    break;
                case 'lv7': 
                    checkpoints = [
                        {x: w*0.2, y: h*0.45, r: 100}, {x: w*0.5, y: h*0.1, r: 100},
                        {x: w*0.8, y: h*0.45, r: 100}, {x: w*0.5, y: h*0.9, r: 100}
                    ];
                    break;
                case 'lv8': 
                    startX = locSci.x; startY = locSci.y + 100;
                    targetZones.push({ ...locAgri, type: 'stop', active: true });
                    break;
                case 'lv9': 
                     startX = locAgri.x; startY = locAgri.y + 200; startAngle = Math.PI/2;
                     targetZones.push({ ...locParking, type: 'stop', active: true, strict: true });
                     break;
                case 'lv10':
                     cans.push({id: 1, x: locEng.x + locEng.w/2, y: locEng.y + locEng.h + 50, color: 'red', radius: 15, grabbed: false});
                     cans.push({id: 2, x: locAgri.x + locAgri.w/2, y: locAgri.y + locAgri.h + 50, color: 'green', radius: 15, grabbed: false});
                     targetZones.push({ ...locParking, type: 'stop', active: true });
                     break;
                case 'lv11': startX = w*0.25; startY = h*0.9; checkpoints = [{x: w*0.25, y: h*0.75, r: 60}, {x: w*0.35, y: h*0.6, r: 60}, {x: w*0.25, y: h*0.45, r: 60}, {x: w*0.35, y: h*0.3, r: 60}, {x: w*0.25, y: h*0.15, r: 80}]; break;
                case 'lv12': startX = w*0.75; startY = h*0.8; startAngle = -Math.PI/2; targetZones.push({ x: w*0.75, y: h*0.85, w: 100, h: 100, type: 'stop', active: true}); break;
                case 'lv13': startX = w*0.5; startY = h*0.5; checkpoints = [{x: w*0.4, y: h*0.4, r: 80}, {x: w*0.6, y: h*0.4, r: 80}, {x: w*0.5, y: h*0.5, r: 60}]; break;
                case 'lv14': startX = w*0.5; startY = h*0.5; targetZones.push({ x: w*0.5, y: h*0.2, w: 100, h: 100, type: 'stop', active: true}); break;
                case 'lv15': startX = w*0.25; startY = h*0.2; startAngle = Math.PI/2; targetZones = [{ x: w*0.25, y: h*0.8, w: 100, h: 100, type: 'stop', active: true}]; break;
                case 'lv16': cans.push({id: 1, x: startX, y: startY - 100, color: 'red', radius: 15, grabbed: false}); cans.push({id: 2, x: locSci.x, y: locSci.y + 100, color: 'blue', radius: 15, grabbed: false}); cans.push({id: 3, x: locAgri.x, y: locAgri.y + 100, color: 'green', radius: 15, grabbed: false}); targetZones.push({ ...locMed, type: 'drop', active: true }); break;
                case 'lv17': startX = w*0.1; startY = h*0.9; checkpoints = [{x: w*0.1, y: h*0.1, r: 100}, {x: w*0.9, y: h*0.1, r: 100}, {x: w*0.9, y: h*0.9, r: 100}, {x: w*0.1, y: h*0.9, r: 100}]; break;
                case 'lv18': startX = w*0.1; startY = h*0.9; checkpoints = [{x: w*0.2, y: h*0.8, r: 60}, {x: w*0.3, y: h*0.7, r: 60}, {x: w*0.4, y: h*0.6, r: 60}, {x: w*0.5, y: h*0.5, r: 60}]; break;
                case 'lv19': targetZones.push({ x: startX, y: startY-200, w: 100, h: 100, type: 'stop', active: true}); break;
                case 'lv20': startX = w*0.5; startY = h*0.9; cans.push({id: 1, x: w*0.2, y: h*0.5, color: 'red', radius: 15, grabbed: false}); cans.push({id: 2, x: w*0.8, y: h*0.5, color: 'blue', radius: 15, grabbed: false}); targetZones.push({ x: w*0.5, y: h*0.1, w: 200, h: 200, type: 'stop', active: true}); break;
            }

            robot.x = startX;
            robot.y = startY;
            robot.angle = startAngle;

            oled.innerText = "Ready...";
            updateDashboard();
            resetCamera();
            draw();
        }

        // --- Drawing ---
        function draw() {
            ctx.setTransform(1, 0, 0, 1, 0, 0); 
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            
            ctx.translate(cx, cy);
            ctx.scale(camera.scale, camera.scale);
            ctx.translate(-camera.x, -camera.y);

            drawUbonMap();

            if (checkpoints.length > 0) {
                checkpoints.forEach((cp, idx) => {
                    ctx.beginPath();
                    ctx.arc(cp.x, cp.y, cp.r, 0, Math.PI*2);
                    ctx.fillStyle = idx === currentCheckpointIndex ? 'rgba(239, 68, 68, 0.4)' : 'rgba(209, 213, 219, 0.3)';
                    ctx.fill();
                    ctx.strokeStyle = idx === currentCheckpointIndex ? '#ef4444' : '#9ca3af';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.fillStyle = '#000';
                    ctx.font = 'bold 30px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(idx+1, cp.x, cp.y);
                });
            }

            targetZones.forEach(z => {
                if (!z.active) return;
                const pulse = Math.sin(Date.now() / 200) * 0.2 + 0.4;
                ctx.fillStyle = z.type === 'drop' ? `rgba(16, 185, 129, ${pulse})` : `rgba(239, 68, 68, ${pulse})`;
                ctx.fillRect(z.x - z.w/2, z.y - z.h/2, z.w, z.h);
                ctx.strokeStyle = z.type === 'drop' ? '#10B981' : '#EF4444';
                ctx.lineWidth = 4;
                ctx.strokeRect(z.x - z.w/2, z.y - z.h/2, z.w, z.h);
                
                ctx.fillStyle = '#000';
                ctx.font = "bold 30px Prompt";
                ctx.textAlign = "center";
                ctx.fillText(z.type === 'drop' ? "‡∏à‡∏∏‡∏î‡∏ß‡∏≤‡∏á" : "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢", z.x, z.y);
            });

            cans.forEach(can => {
                if (!can.grabbed) drawCan(can.x, can.y, can.color, can.radius);
            });

            drawRobot();
        }

        function drawUbonMap() {
            const w = WORLD_W;
            const h = WORLD_H;
            ctx.fillStyle = '#f8fafc'; ctx.fillRect(0,0, w, h);
            ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 10; ctx.strokeRect(0,0, w, h);

            ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.lineWidth = 80; ctx.strokeStyle = '#334155'; 
            ctx.beginPath();
            ctx.moveTo(w*0.25, h*0.2); ctx.lineTo(w*0.25, h*0.8); ctx.lineTo(w*0.75, h*0.8); ctx.lineTo(w*0.75, h*0.2); ctx.lineTo(w*0.25, h*0.2);
            ctx.moveTo(w*0.25, h*0.5); ctx.lineTo(w*0.75, h*0.5);
            ctx.moveTo(w*0.5, h*0.2); ctx.lineTo(w*0.5, h*0.5);
            ctx.moveTo(w*0.5, h*0.8); ctx.lineTo(w*0.5, h*0.95); 
            ctx.stroke();
            
            ctx.lineWidth = 4; ctx.strokeStyle = '#ffffff'; ctx.setLineDash([20, 30]); ctx.stroke(); ctx.setLineDash([]); 

            drawBuilding(w*0.1, h*0.1, w*0.2, h*0.3, '#fca5a5', '‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå');
            drawBuilding(w*0.4, h*0.05, w*0.2, h*0.25, '#fde047', '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå');
            drawBuilding(w*0.7, h*0.1, w*0.2, h*0.3, '#86efac', '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå');
            drawBuilding(w*0.35, h*0.6, w*0.3, h*0.15, '#93c5fd', '‡πÅ‡∏û‡∏ó‡∏¢‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå');

            ctx.fillStyle = 'rgba(59, 130, 246, 0.3)'; ctx.fillRect(w*0.45, h*0.9, w*0.1, h*0.1);
            ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 5; ctx.strokeRect(w*0.45, h*0.9, w*0.1, h*0.1);
            ctx.fillStyle = '#1e3a8a'; ctx.font = "bold 32px Prompt"; ctx.textAlign = "center"; ctx.fillText("START", w*0.5, h*0.95);
        }

        function drawBuilding(x, y, w, h, color, label) {
            ctx.fillStyle = color; ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = 'rgba(0,0,0,0.1)'; ctx.lineWidth = 2; ctx.strokeRect(x, y, w, h);
            ctx.fillStyle = '#374151'; ctx.font = 'bold 24px Prompt'; ctx.textAlign = 'center'; ctx.fillText(label, x + w/2, y + h/2);
        }

        function drawCan(x, y, color, r) {
            ctx.fillStyle = color; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = 'rgba(0,0,0,0.5)'; ctx.lineWidth = 2; ctx.stroke();
            ctx.fillStyle = 'rgba(255,255,255,0.8)'; ctx.beginPath(); ctx.arc(x - r/3, y - r/3, r/4, 0, Math.PI*2); ctx.fill();
        }

        function drawRobot() {
            ctx.save(); ctx.translate(robot.x, robot.y); ctx.rotate(robot.angle);
            const visualAngle = (robot.servoAngle / 90) * (Math.PI / 4); 
            ctx.strokeStyle = '#4b5563'; ctx.lineWidth = 6;
            ctx.beginPath(); ctx.moveTo(15, -10); ctx.lineTo(15 + 20 * Math.cos(visualAngle), -10 - 20 * Math.sin(visualAngle)); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(15, 10); ctx.lineTo(15 + 20 * Math.cos(visualAngle), 10 + 20 * Math.sin(visualAngle)); ctx.stroke();
            if (robot.holdingObject) drawCan(25, 0, robot.holdingObject.color, robot.holdingObject.radius);
            ctx.fillStyle = ROBOT_COLOR; ctx.beginPath(); ctx.roundRect(-ROBOT_SIZE/2, -ROBOT_SIZE/2, ROBOT_SIZE, ROBOT_SIZE, 8); ctx.fill();
            ctx.fillStyle = '#111827'; ctx.fillRect(-10, -ROBOT_SIZE/2 - 5, 20, 5); ctx.fillRect(-10, ROBOT_SIZE/2, 20, 5); 
            ctx.fillStyle = '#FCD34D'; ctx.beginPath(); ctx.moveTo(10, 0); ctx.lineTo(-5, -6); ctx.lineTo(-5, 6); ctx.fill();
            ctx.restore();
        }

        // --- Physics ---
        function updatePhysics(dt) {
            const speedMultiplier = 3.5; 
            let vL = robot.speedL * speedMultiplier;
            let vR = robot.speedR * speedMultiplier;
            let v = (vL + vR) / 2;
            let rotationSpeed = (vR - vL) / ROBOT_SIZE * 0.8; 
            robot.x += Math.cos(robot.angle) * v * dt;
            robot.y += Math.sin(robot.angle) * v * dt;
            robot.angle += rotationSpeed * dt;
            if (robot.x < 0) robot.x = 0; if (robot.x > WORLD_W) robot.x = WORLD_W;
            if (robot.y < 0) robot.y = 0; if (robot.y > WORLD_H) robot.y = WORLD_H;
            checkMission();
        }

        function attemptGrab() {
            const reach = 50; const grabX = robot.x + Math.cos(robot.angle) * 30; const grabY = robot.y + Math.sin(robot.angle) * 30;
            let grabbed = null;
            cans.forEach(can => { if (can.grabbed) return; let d = Math.hypot(can.x - grabX, can.y - grabY); if (d < reach) grabbed = can; });
            if (grabbed) { grabbed.grabbed = true; robot.holdingObject = grabbed; playTone(1000, 100); }
        }

        function attemptDrop() {
            if (robot.holdingObject) {
                robot.holdingObject.grabbed = false; robot.holdingObject.x = robot.x + Math.cos(robot.angle) * 40; robot.holdingObject.y = robot.y + Math.sin(robot.angle) * 40; robot.holdingObject = null;
            }
        }

        function checkMission() {
            if (!isRunning) return;
            if (checkpoints.length > 0) {
                if (currentCheckpointIndex < checkpoints.length) {
                    let cp = checkpoints[currentCheckpointIndex];
                    let dist = Math.hypot(robot.x - cp.x, robot.y - cp.y);
                    if (dist < cp.r) { currentCheckpointIndex++; playTone(600, 100); if (currentCheckpointIndex >= checkpoints.length) showSuccess(); }
                }
                return;
            }
            targetZones.forEach(z => {
                if (!z.active) return;
                let inZone = (robot.x > z.x - z.w/2 && robot.x < z.x + z.w/2 && robot.y > z.y - z.h/2 && robot.y < z.y + z.h/2);
                if (inZone) {
                    if (z.type === 'stop') { if (Math.abs(robot.speedL) < 5 && Math.abs(robot.speedR) < 5) showSuccess(); }
                    else if (z.type === 'drop') {
                        let itemInZone = false;
                        cans.forEach(c => { if (!c.grabbed && c.x > z.x - z.w/2 && c.x < z.x + z.w/2 && c.y > z.y - z.h/2 && c.y < z.y + z.h/2) itemInZone = true; });
                        if (itemInZone) showSuccess();
                    }
                }
            });
        }

        function showSuccess() { isRunning = false; successOverlay.classList.remove('hidden'); successOverlay.classList.add('flex'); playTone(800, 100); setTimeout(() => playTone(1200, 300), 150); }
        function closeSuccess() { successOverlay.classList.add('hidden'); successOverlay.classList.remove('flex'); }
        function nextLevel() { closeSuccess(); let select = document.getElementById('missionSelect'); if (select.selectedIndex < select.options.length - 1) { select.selectedIndex++; select.dispatchEvent(new Event('change')); } }

        // --- Interpreter ---
        function parseCode(source) {
            const lines = source.split('\n');
            const commands = [];
            lines.forEach((line, index) => {
                let cleanLine = line.split('//')[0].trim();
                if (!cleanLine) return;
                if (cleanLine.startsWith('#') || cleanLine.startsWith('void') || cleanLine === '{' || cleanLine === '}') return;
                let match = cleanLine.match(/([a-zA-Z0-9_]+)\((.*)\);?/);
                if (match) {
                    let cmd = match[1]; let argsStr = match[2]; let args = [];
                    if (argsStr.includes('"')) { let strMatch = argsStr.match(/"([^"]+)"/); if (strMatch) args.push(strMatch[1]); let numMatch = argsStr.split(',')[0].trim(); if (!isNaN(numMatch)) args.unshift(parseInt(numMatch)); } else { args = argsStr.split(',').map(s => parseFloat(s.trim())); }
                    let type = cmd.toLowerCase(); if (type === 'delay') type = 'sleep';
                    commands.push({ type: type, args: args, line: index + 1 });
                }
            });
            commands.push({ type: 'ao', args: [] });
            return commands;
        }

        function runSimulation() {
            if (isRunning) return;
            commandQueue = parseCode(editor.value);
            if (commandQueue.length === 0) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î"); return; }
            isRunning = true; currentCommandIndex = 0; commandStartTime = 0; lastTimestamp = performance.now();
            runBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...'; runBtn.className = "flex-1 bg-orange-500 text-white py-2 rounded font-semibold transition flex items-center justify-center gap-2"; statusIndicator.innerHTML = '<span class="text-green-500">Running</span>';
            requestAnimationFrame(gameLoop);
        }

        function resetSimulation() {
            isRunning = false; cancelAnimationFrame(animationFrame); resetScenario();
            runBtn.innerHTML = '<i class="fas fa-play"></i> Upload & Run'; runBtn.className = "flex-1 bg-green-600 hover:bg-green-500 text-white py-2 rounded font-semibold transition flex items-center justify-center gap-2"; statusIndicator.innerHTML = '<span class="text-yellow-500">Ready</span>';
        }

        function gameLoop(timestamp) {
            if (!isRunning) return;
            const dt = (timestamp - lastTimestamp) / 1000; lastTimestamp = timestamp;
            if (currentCommandIndex < commandQueue.length) {
                const cmd = commandQueue[currentCommandIndex];
                if (commandStartTime === 0) { commandStartTime = timestamp; executeCommand(cmd); }
                if (cmd.type === 'sleep') { if (timestamp - commandStartTime >= cmd.args[0]) nextCommand(); } else { nextCommand(); }
            } else {
                isRunning = false; robot.speedL = 0; robot.speedR = 0; updateDashboard();
                runBtn.innerHTML = '<i class="fas fa-check"></i> Done';
                setTimeout(() => { runBtn.innerHTML = '<i class="fas fa-play"></i> Upload & Run'; runBtn.className = "flex-1 bg-green-600 hover:bg-green-500 text-white py-2 rounded font-semibold"; }, 1000);
            }
            updatePhysics(dt); draw();
            if (isRunning) animationFrame = requestAnimationFrame(gameLoop);
        }

        function nextCommand() { currentCommandIndex++; commandStartTime = 0; }
        
        function executeCommand(cmd) {
            switch(cmd.type) {
                case 'fd': robot.speedL = cmd.args[0]; robot.speedR = cmd.args[0]; break;
                case 'bk': robot.speedL = -cmd.args[0]; robot.speedR = -cmd.args[0]; break;
                case 'sl': robot.speedL = -cmd.args[0]; robot.speedR = cmd.args[0]; break;
                case 'sr': robot.speedL = cmd.args[0]; robot.speedR = -cmd.args[0]; break;
                case 'ao': robot.speedL = 0; robot.speedR = 0; break;
                case 'motor': if (cmd.args[0] === 1) robot.speedL = cmd.args[1]; if (cmd.args[0] === 2) robot.speedR = cmd.args[1]; break;
                case 'servo': setGripper(cmd.args[1] !== undefined ? cmd.args[1] : cmd.args[0]); break;
                case 'gripper': setGripper(cmd.args[0]); break;
                case 'glcd': if (cmd.args[0] === 0) oled.innerText = cmd.args[1]; else oled.innerText += "\n" + cmd.args[1]; break;
            }
            updateDashboard();
        }

        function setGripper(angle) { robot.servoAngle = angle; if (angle <= 45) attemptGrab(); else if (angle >= 80) attemptDrop(); }
        function playTone(freq, duration) { const AudioContext = window.AudioContext || window.webkitAudioContext; const audioCtx = new AudioContext(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'square'; osc.frequency.setValueAtTime(freq, audioCtx.currentTime); gain.gain.setValueAtTime(0.05, audioCtx.currentTime); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); setTimeout(() => osc.stop(), duration); }
        function updateDashboard() { motorLDisp.innerText = Math.round(robot.speedL); motorRDisp.innerText = Math.round(robot.speedR); servoDisp.innerText = robot.servoAngle + "¬∞"; }

        // --- UI Interactions ---
        const missionSelect = document.getElementById('missionSelect');
        const missionBox = document.getElementById('missionBox');
        const missionText = document.getElementById('missionText');
        const successOverlay = document.getElementById('successOverlay');

        missionSelect.addEventListener('change', (e) => {
            currentLevel = e.target.value;
            setMissionUI(currentLevel);
            resetSimulation();
        });

        // AI Logic
        function openAI() {
            document.getElementById('aiModal').classList.remove('hidden');
            const levelInfo = levelData[currentLevel] || { name: "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏î‡πà‡∏≤‡∏ô" };
            document.getElementById('aiLevelName').innerText = levelInfo.name;
            // Clear old chat
             document.getElementById('aiChatContent').innerHTML = `
                <p class="text-gray-700 bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                    ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <strong>${levelInfo.name}</strong> ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?
                </p>`;
        }

        function closeAI() {
            document.getElementById('aiModal').classList.add('hidden');
        }

        function addAiMessage(text, isUser = false) {
            const div = document.createElement('div');
            div.className = isUser ? "bg-indigo-100 text-indigo-900 p-3 rounded-lg self-end text-right" : "bg-white text-gray-700 p-3 rounded-lg shadow-sm border border-gray-200";
            div.innerHTML = text;
            document.getElementById('aiChatContent').appendChild(div);
            // Scroll to bottom (optional if needed)
        }

        function aiGetHint() {
            const hint = levelData[currentLevel].hint;
            addAiMessage("‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö", true);
            setTimeout(() => addAiMessage(`üí° <strong>‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ:</strong> ${hint}`), 500);
        }

        function aiCheckCode() {
            addAiMessage("‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢", true);
            const code = editor.value;
            let advice = "‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡∏π‡∏õ‡∏Å‡∏ï‡∏¥‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏•‡∏≠‡∏á‡∏Å‡∏î Run ‡∏î‡∏π‡πÄ‡∏•‡∏¢!";
            
            // Basic Check Rules
            if (!code.includes("AO()")) advice = "‚ö†Ô∏è ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏™‡∏±‡πà‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á <code>AO();</code> ‡∏ó‡∏µ‡πà‡∏ó‡πâ‡∏≤‡∏¢‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏´‡∏∏‡πà‡∏ô‡∏à‡∏∞‡∏ß‡∏¥‡πà‡∏á‡πÑ‡∏°‡πà‡∏´‡∏¢‡∏∏‡∏î!";
            else if (currentLevel.includes("lv5") && !code.includes("servo")) advice = "‚ö†Ô∏è ‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏ö ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á <code>servo(1, ‡∏≠‡∏á‡∏®‡∏≤);</code> ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö";
            else if (!code.includes("delay")) advice = "‚ö†Ô∏è ‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà <code>delay(ms);</code> ‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö";

            setTimeout(() => addAiMessage(`üßê <strong>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à:</strong> ${advice}`), 600);
        }

        function aiRevealSolution() {
            if(confirm("‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢? ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡πÑ‡∏´‡∏°?")) {
                addAiMessage("‡∏Ç‡∏≠‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢‡πÄ‡∏•‡∏¢‡∏•‡∏∞‡∏Å‡∏±‡∏ô", true);
                const sol = levelData[currentLevel].code;
                setTimeout(() => {
                    addAiMessage("üîì <strong>‡πÄ‡∏â‡∏•‡∏¢:</strong> ‡∏ú‡∏°‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡πÉ‡∏ô Editor ‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‡∏•‡∏≠‡∏á‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏î‡∏π‡∏ô‡∏∞");
                    // Insert into editor but keep structure
                    editor.value = `#include <POP32.h>\n\nvoid setup() {\n  oled.text(0,0,"Solution Loaded");\n}\n\nvoid loop() {\n${sol}\n}`;
                    closeAI();
                }, 800);
            }
        }

        function setMissionUI(level) {
            missionBox.classList.remove('hidden'); missionBox.classList.add('flex');
            let info = levelData[level];
            missionText.innerText = info.name;
            // Clear Editor (Don't show solution)
            editor.value = `#include <POP32.h>\n\nvoid setup() {\n  oled.text(0, 0, "Mission Start");\n}\n\nvoid loop() {\n  // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà\n  \n}`;
        }

        // Start
        resizeCanvas();
        setMissionUI('lv1');
        
    </script>
</body>
</html>
