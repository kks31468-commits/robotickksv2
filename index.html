<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>POP32i Simulator: Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&family=Source+Code+Pro:wght@400;700&display=swap');
        
        body { font-family: 'Prompt', sans-serif; background-color: #111827; height: 100vh; overflow: hidden; color: #e5e7eb; }
        .code-font { font-family: 'Source Code Pro', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .canvas-bg {
            background-image: linear-gradient(#374151 1px, transparent 1px), linear-gradient(90deg, #374151 1px, transparent 1px);
            background-size: 40px 40px;
            background-color: #1f2937;
            cursor: grab;
            touch-action: none; /* Prevent browser scrolling on canvas */
        }
        .canvas-bg:active { cursor: grabbing; }
        
        optgroup { font-weight: bold; color: #fbbf24; background-color: #3730a3; }
        option { color: white; background-color: #4338ca; }

        /* Autocomplete & Tooltips */
        #suggestionBox {
            position: absolute; background: #1f2937; border: 1px solid #4b5563; border-radius: 6px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); z-index: 50; max-height: 200px;
            overflow-y: auto; min-width: 200px; display: none;
        }
        .suggestion-item { padding: 8px 12px; cursor: pointer; color: #e5e7eb; font-family: 'Source Code Pro', monospace; font-size: 13px; display: flex; justify-content: space-between; }
        .suggestion-item:hover, .suggestion-item.active { background-color: #2563eb; color: white; }
        
        .cmd-btn:hover { transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .cmd-btn:active { transform: translateY(0); }

        /* Animations */
        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .btn-run { animation: pulse-glow 2s infinite; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Header -->
    <header class="bg-gray-900 border-b border-gray-700 p-2 md:p-3 shadow-lg flex flex-wrap justify-between items-center shrink-0 z-30 gap-2">
        <div class="flex items-center gap-2 md:gap-3">
            <div class="w-8 h-8 md:w-10 md:h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold text-lg md:text-xl shadow-lg border border-gray-600">
                <i class="fas fa-microchip"></i>
            </div>
            <div>
                <h1 class="text-base md:text-lg font-bold text-white tracking-wide leading-tight">POP32i <span class="text-indigo-400">IDE</span></h1>
                <p class="text-[9px] md:text-[10px] text-gray-400 hidden sm:block">Simulator & AI Assistant</p>
            </div>
        </div>
        
        <div class="flex gap-2 items-center flex-1 justify-end">
            <div class="flex flex-col items-end max-w-[150px] md:max-w-none">
                <label class="text-[9px] md:text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-0.5 hidden md:block">Current Mission</label>
                <select id="missionSelect" class="bg-gray-800 text-indigo-300 border border-gray-600 rounded px-2 py-1 md:px-3 md:py-1.5 text-xs md:text-sm focus:outline-none focus:border-indigo-500 w-full md:w-64 transition-all">
                    <option value="free">üõ†Ô∏è Sandbox (‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏¥‡∏™‡∏£‡∏∞)</option>
                    <optgroup label="Level 1-4: Basic Movement">
                        <option value="lv1">‡∏î‡πà‡∏≤‡∏ô 1: ‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏ß‡∏¥‡∏®‡∏ß‡∏∞</option>
                        <option value="lv2">‡∏î‡πà‡∏≤‡∏ô 2: ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏•‡πÑ‡∏õ‡∏ß‡∏¥‡∏ó‡∏¢‡πå</option>
                        <option value="lv3">‡∏î‡πà‡∏≤‡∏ô 3: ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
                        <option value="lv4">‡∏î‡πà‡∏≤‡∏ô 4: ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏Ç‡∏ß‡∏≤‡πÑ‡∏õ‡πÄ‡∏Å‡∏©‡∏ï‡∏£</option>
                    </optgroup>
                    <optgroup label="Level 5-10: Gripper & Logic">
                        <option value="lv5">‡∏î‡πà‡∏≤‡∏ô 5: ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏î‡πà‡∏ß‡∏ô (Pick & Place)</option>
                        <option value="lv6">‡∏î‡πà‡∏≤‡∏ô 6: ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏ï‡∏∂‡∏Å</option>
                        <option value="lv7">‡∏î‡πà‡∏≤‡∏ô 7: ‡πÄ‡∏î‡∏¥‡∏ô‡∏ß‡∏ô Loop</option>
                        <option value="lv8">‡∏î‡πà‡∏≤‡∏ô 8: Checkpoint</option>
                        <option value="lv9">‡∏î‡πà‡∏≤‡∏ô 9: ‡∏ñ‡∏≠‡∏¢‡∏à‡∏≠‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ã‡∏≠‡∏á</option>
                        <option value="lv10">‡∏î‡πà‡∏≤‡∏ô 10: ‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ (Full)</option>
                    </optgroup>
                    <optgroup label="Level 11-20: Expert Challenges">
                        <option value="lv11">‡∏î‡πà‡∏≤‡∏ô 11: ‡∏ã‡∏¥‡∏Å‡πÅ‡∏ã‡∏Å (Slalom)</option>
                        <option value="lv12">‡∏î‡πà‡∏≤‡∏ô 12: ‡∏Å‡∏•‡∏±‡∏ö‡∏£‡∏ñ‡∏ï‡∏±‡∏ß U</option>
                        <option value="lv13">‡∏î‡πà‡∏≤‡∏ô 13: ‡πÄ‡∏•‡∏Ç 8 ‡∏°‡∏´‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå</option>
                        <option value="lv14">‡∏î‡πà‡∏≤‡∏ô 14: ‡∏Å‡πâ‡∏ô‡∏´‡∏≠‡∏¢ (Spiral)</option>
                        <option value="lv15">‡∏î‡πà‡∏≤‡∏ô 15: ‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏¢‡∏≤‡∏ß</option>
                        <option value="lv16">‡∏î‡πà‡∏≤‡∏ô 16: ‡∏™‡πà‡∏á 3 ‡∏à‡∏∏‡∏î</option>
                        <option value="lv17">‡∏î‡πà‡∏≤‡∏ô 17: ‡∏£‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡∏≠‡∏á</option>
                        <option value="lv18">‡∏î‡πà‡∏≤‡∏ô 18: ‡∏ü‡∏±‡∏ô‡∏õ‡∏•‡∏≤</option>
                        <option value="lv19">‡∏î‡πà‡∏≤‡∏ô 19: 360 Spin</option>
                        <option value="lv20">‡∏î‡πà‡∏≤‡∏ô 20: FINAL EXAM</option>
                    </optgroup>
                </select>
            </div>
            
            <button onclick="openAI()" class="bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-500 hover:to-cyan-400 text-white px-2 py-1 md:px-4 md:py-2 rounded-lg text-xs md:text-sm font-bold shadow-lg flex items-center gap-1 md:gap-2 border border-blue-400/30 transition-all transform hover:scale-105">
                <i class="fas fa-robot"></i> <span class="hidden sm:inline">AI Helper</span>
            </button>
            
            <button onclick="openManual()" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-2 py-1 md:px-4 md:py-2 rounded-lg text-xs md:text-sm font-bold shadow flex items-center gap-1 md:gap-2 border border-gray-600 transition-all">
                <i class="fas fa-book"></i> <span class="hidden sm:inline">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠</span>
            </button>
        </div>
    </header>

    <!-- Main Workspace (Responsive Layout) -->
    <!-- iPad/Desktop: Row (Side by Side) | Mobile: Column (Stack) -->
    <div class="flex flex-1 overflow-hidden flex-col md:flex-row">
        
        <!-- Code Editor Section -->
        <div class="w-full h-1/2 md:h-full md:w-[45%] lg:w-[40%] bg-gray-900 flex flex-col border-b md:border-b-0 md:border-r border-gray-700 relative z-10 shadow-2xl order-1">
            <!-- Toolbar -->
            <div class="bg-gray-800 p-2 flex flex-wrap gap-1 border-b border-gray-700 select-none overflow-x-auto whitespace-nowrap">
                <button onclick="insertCode('FD(50); ')" class="cmd-btn bg-gray-700 text-green-400 text-xs px-2 py-1.5 rounded border border-gray-600 font-mono font-bold">FD</button>
                <button onclick="insertCode('BK(50); ')" class="cmd-btn bg-gray-700 text-red-400 text-xs px-2 py-1.5 rounded border border-gray-600 font-mono font-bold">BK</button>
                <button onclick="insertCode('SL(50); ')" class="cmd-btn bg-gray-700 text-yellow-400 text-xs px-2 py-1.5 rounded border border-gray-600 font-mono font-bold">SL</button>
                <button onclick="insertCode('SR(50); ')" class="cmd-btn bg-gray-700 text-yellow-400 text-xs px-2 py-1.5 rounded border border-gray-600 font-mono font-bold">SR</button>
                <div class="w-px h-6 bg-gray-600 mx-1"></div>
                <button onclick="insertCode('delay(1000); ')" class="cmd-btn bg-gray-700 text-blue-300 text-xs px-2 py-1.5 rounded border border-gray-600 font-mono font-bold">delay</button>
                <button onclick="insertCode('AO(); ')" class="cmd-btn bg-gray-700 text-red-500 text-xs px-2 py-1.5 rounded border border-gray-600 font-mono font-bold">AO</button>
                <button onclick="insertCode('servo(1, 90); ')" class="cmd-btn bg-gray-700 text-purple-400 text-xs px-2 py-1.5 rounded border border-gray-600 font-mono font-bold">servo</button>
                <button onclick="insertCode('oled.text(0,0,\"\"); ')" class="cmd-btn bg-gray-700 text-cyan-400 text-xs px-2 py-1.5 rounded border border-gray-600 font-mono font-bold">oled</button>
            </div>
            
            <!-- Editor Area -->
            <div class="relative flex-1 group min-h-0">
                <div class="absolute left-0 top-0 bottom-0 w-8 bg-gray-800 text-gray-500 text-[10px] pt-4 text-right pr-2 select-none border-r border-gray-700 font-mono leading-relaxed" id="lineNumbers">1</div>
                <textarea id="codeEditor" class="w-full h-full bg-[#0d1117] text-gray-100 code-font p-4 pl-10 outline-none resize-none text-sm leading-relaxed" spellcheck="false" placeholder="// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                <div id="suggestionBox"></div>
            </div>

            <!-- Action Bar -->
            <div class="p-2 md:p-3 bg-gray-800 border-t border-gray-700 flex gap-2 items-center justify-end">
                <div id="statusIndicator" class="text-[10px] md:text-xs font-mono mr-auto flex items-center gap-1 md:gap-2 px-2 py-1 bg-gray-900 rounded border border-gray-700 text-yellow-500 hidden sm:flex">
                    <span class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></span> READY
                </div>
                <button onclick="resetSimulation()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 md:px-4 md:py-2 rounded font-bold text-xs md:text-sm transition flex items-center gap-2 border border-gray-600">
                    <i class="fas fa-undo"></i> <span class="hidden sm:inline">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</span>
                </button>
                <button onclick="runSimulation()" id="runBtn" class="bg-green-600 hover:bg-green-500 text-white px-4 py-1.5 md:px-6 md:py-2 rounded font-bold text-xs md:text-sm transition flex items-center gap-2 shadow-lg shadow-green-900/50 btn-run">
                    <i class="fas fa-play"></i> <span id="runBtnText">Upload & Run</span>
                </button>
            </div>
        </div>

        <!-- Simulation Canvas Section -->
        <div class="flex-1 flex flex-col relative bg-[#1f2937] overflow-hidden order-2 min-h-0">
            <!-- HUD -->
            <div class="absolute top-2 left-2 md:top-4 md:left-4 z-10 flex flex-col gap-2 pointer-events-none">
                <!-- OLED -->
                <div class="bg-black/80 backdrop-blur border-2 border-gray-600 rounded-lg p-1 w-32 md:w-40 pointer-events-auto shadow-xl">
                    <div class="text-[8px] md:text-[9px] text-gray-400 text-center uppercase tracking-widest mb-1 border-b border-gray-800">POP32i OLED</div>
                    <div id="oledScreen" class="text-cyan-400 font-mono text-[9px] md:text-[10px] p-1 md:p-2 h-12 md:h-16 overflow-hidden whitespace-pre-wrap leading-tight">System Ready...</div>
                </div>
                <!-- Motors -->
                <div class="bg-gray-800/90 backdrop-blur border border-gray-600 rounded p-2 pointer-events-auto shadow-lg min-w-[100px] md:min-w-[120px]">
                    <div class="flex justify-between text-[10px] md:text-xs font-mono mb-1 text-gray-400"><span>L</span><span id="motorL" class="text-green-400 font-bold">0</span></div>
                    <div class="flex justify-between text-[10px] md:text-xs font-mono mb-1 text-gray-400"><span>R</span><span id="motorR" class="text-green-400 font-bold">0</span></div>
                    <div class="h-px bg-gray-600 my-1"></div>
                    <div class="flex justify-between text-[10px] md:text-xs font-mono text-gray-400"><span>Sv</span><span id="servoVal" class="text-purple-400 font-bold">90¬∞</span></div>
                </div>
            </div>

            <!-- Controls -->
            <div class="absolute bottom-4 right-4 md:bottom-6 md:right-6 z-10 flex flex-col gap-2">
                <button onclick="zoomIn()" class="w-8 h-8 md:w-10 md:h-10 bg-gray-700/80 hover:bg-gray-600 text-white rounded-full shadow-lg flex items-center justify-center font-bold border border-gray-500 transition backdrop-blur"><i class="fas fa-plus text-xs md:text-base"></i></button>
                <button onclick="resetCamera()" class="w-8 h-8 md:w-10 md:h-10 bg-gray-700/80 hover:bg-gray-600 text-white rounded-full shadow-lg flex items-center justify-center font-bold border border-gray-500 transition backdrop-blur"><i class="fas fa-compress text-xs md:text-base"></i></button>
                <button onclick="zoomOut()" class="w-8 h-8 md:w-10 md:h-10 bg-gray-700/80 hover:bg-gray-600 text-white rounded-full shadow-lg flex items-center justify-center font-bold border border-gray-500 transition backdrop-blur"><i class="fas fa-minus text-xs md:text-base"></i></button>
            </div>

            <canvas id="simCanvas" class="w-full h-full canvas-bg block touch-none"></canvas>

            <!-- Mission Popup -->
            <div id="missionBox" class="absolute bottom-4 md:bottom-8 left-1/2 transform -translate-x-1/2 bg-gray-800/95 backdrop-blur shadow-2xl rounded-full px-4 py-2 md:px-6 md:py-3 border border-indigo-500 flex items-center gap-3 md:gap-4 animate-bounce z-20 pointer-events-none min-w-[250px] md:min-w-[300px] justify-center">
                <div class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-indigo-500 flex items-center justify-center text-white text-xs md:text-sm"><i class="fas fa-flag"></i></div>
                <div>
                    <div class="text-[8px] md:text-[10px] text-indigo-300 font-bold uppercase tracking-wider">Mission Objective</div>
                    <span id="missionText" class="text-xs md:text-sm font-semibold text-white">Select a mission</span>
                </div>
            </div>

            <!-- Success Overlay -->
            <div id="successOverlay" class="absolute inset-0 bg-black/80 backdrop-blur-sm hidden flex-col items-center justify-center text-white z-50 p-4 text-center">
                <div class="text-5xl md:text-6xl text-yellow-400 mb-4 md:mb-6 animate-bounce drop-shadow-[0_0_15px_rgba(250,204,21,0.5)]"><i class="fas fa-trophy"></i></div>
                <h2 class="text-3xl md:text-4xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500">Mission Complete!</h2>
                <p class="text-gray-400 mb-6 md:mb-8 font-mono text-xs md:text-sm">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö</p>
                <div class="flex gap-4">
                    <button onclick="closeSuccess()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 md:px-6 md:py-2 rounded-lg font-bold border border-gray-500 transition text-sm md:text-base">‡πÄ‡∏•‡πà‡∏ô‡∏ã‡πâ‡∏≥</button>
                    <button onclick="nextLevel()" class="bg-indigo-600 hover:bg-indigo-500 px-6 py-2 md:px-8 md:py-2 rounded-lg font-bold border border-indigo-400 shadow-lg shadow-indigo-900/50 transition transform hover:scale-105 text-sm md:text-base">‡∏î‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ <i class="fas fa-arrow-right ml-2"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Helper Modal -->
    <div id="aiModal" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden border border-gray-600 transform transition-all scale-100 flex flex-col max-h-[80vh]">
            <div class="bg-gradient-to-r from-gray-900 to-gray-800 p-4 flex items-center justify-between border-b border-gray-700 shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-inner"><i class="fas fa-robot"></i></div>
                    <div>
                        <h3 class="text-lg font-bold text-white">POP-AI Assistant</h3>
                        <p class="text-[10px] text-green-400 flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-400 rounded-full"></span> Online & Ready</p>
                    </div>
                </div>
                <button onclick="closeAI()" class="text-gray-400 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="p-4 bg-gray-900 flex-1 overflow-y-auto space-y-3" id="aiChatContent">
                <!-- Chat messages -->
            </div>

            <div class="p-4 bg-gray-800 border-t border-gray-700 grid grid-cols-2 gap-3 shrink-0">
                <button onclick="aiGetHint()" class="bg-yellow-600/20 hover:bg-yellow-600/30 text-yellow-400 py-3 rounded-lg border border-yellow-600/50 font-bold text-sm transition flex items-center justify-center gap-2">
                    <i class="fas fa-lightbulb"></i> <span class="hidden sm:inline">‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ</span><span class="sm:hidden">Hint</span>
                </button>
                <button onclick="aiCheckCode()" class="bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 py-3 rounded-lg border border-blue-600/50 font-bold text-sm transition flex items-center justify-center gap-2">
                    <i class="fas fa-search"></i> ‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏Ñ‡πâ‡∏î
                </button>
                <button onclick="aiRevealSolution()" class="col-span-2 bg-red-600/20 hover:bg-red-600/30 text-red-400 py-2 rounded-lg border border-red-600/50 font-bold text-xs transition flex items-center justify-center gap-2 mt-1">
                    <i class="fas fa-unlock"></i> ‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ (‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î)
                </button>
            </div>
        </div>
    </div>

    <!-- Manual Modal -->
    <div id="manualModal" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[85vh] flex flex-col overflow-hidden">
            <div class="p-4 bg-gray-100 border-b flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg text-gray-800"><i class="fas fa-book mr-2"></i> ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á POP32i</h3>
                <button onclick="closeManual()" class="text-gray-500 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-4 md:p-6 overflow-y-auto bg-white text-gray-800 text-sm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <div>
                        <h4 class="font-bold text-indigo-700 border-b pb-1 mb-2">1. ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà (Movement)</h4>
                        <ul class="space-y-2 font-mono text-xs md:text-sm">
                            <li class="flex justify-between"><span class="bg-gray-100 px-2 rounded text-red-600 font-bold">FD(speed)</span> <span class="text-gray-500 font-sans">‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (0-100)</span></li>
                            <li class="flex justify-between"><span class="bg-gray-100 px-2 rounded text-red-600 font-bold">BK(speed)</span> <span class="text-gray-500 font-sans">‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á (0-100)</span></li>
                            <li class="flex justify-between"><span class="bg-gray-100 px-2 rounded text-red-600 font-bold">SL(speed)</span> <span class="text-gray-500 font-sans">‡∏´‡∏°‡∏∏‡∏ô‡∏ã‡πâ‡∏≤‡∏¢</span></li>
                            <li class="flex justify-between"><span class="bg-gray-100 px-2 rounded text-red-600 font-bold">SR(speed)</span> <span class="text-gray-500 font-sans">‡∏´‡∏°‡∏∏‡∏ô‡∏Ç‡∏ß‡∏≤</span></li>
                            <li class="flex justify-between"><span class="bg-gray-100 px-2 rounded text-red-600 font-bold">AO()</span> <span class="text-gray-500 font-sans">‡∏´‡∏¢‡∏∏‡∏î‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå</span></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-indigo-700 border-b pb-1 mb-2">2. ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏° (Devices)</h4>
                        <ul class="space-y-2 font-mono text-xs md:text-sm">
                            <li class="flex flex-col mb-1">
                                <span class="bg-gray-100 px-2 rounded text-purple-600 font-bold w-fit">servo(1, angle)</span>
                                <span class="text-gray-500 text-xs font-sans mt-1 pl-2">‡∏Ñ‡∏∏‡∏°‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÇ‡∏ß‡∏ä‡πà‡∏≠‡∏á 1 (‡∏°‡∏∏‡∏° 0-180)<br>‡πÄ‡∏ä‡πà‡∏ô 20=‡∏´‡∏ô‡∏µ‡∏ö, 90=‡∏Å‡∏≤‡∏á</span>
                            </li>
                            <li class="flex flex-col">
                                <span class="bg-gray-100 px-2 rounded text-blue-600 font-bold w-fit">oled.text(line, col, "text")</span>
                                <span class="text-gray-500 text-xs font-sans mt-1 pl-2">‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏ô‡∏à‡∏≠</span>
                            </li>
                        </ul>
                    </div>
                    <div class="md:col-span-2">
                        <h4 class="font-bold text-indigo-700 border-b pb-1 mb-2">3. ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (Time)</h4>
                        <p class="font-mono bg-gray-100 p-2 rounded text-blue-600 font-bold">delay(ms);</p>
                        <p class="text-gray-500 text-xs mt-1">‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (1000 ms = 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</p>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end shrink-0">
                <button onclick="closeManual()" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
            </div>
        </div>
    </div>

    <!-- Audio Engine -->
    <audio id="beepSound" src="data:audio/wav;base64,UklGRl9vT1dAVXphcnQAAAAAAAAAAAAAAABwY20gAAAAAGAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="></audio>

    <script>
        // --- 1. Level Database & Solutions (FIXED) ---
        const levelData = {
            'free': { name: "‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏¥‡∏™‡∏£‡∏∞", hint: "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏¥‡∏™‡∏£‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏•‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÜ ‡∏î‡∏π‡∏ô‡∏∞", code: "// Sandbox Area\nFD(50);\ndelay(1000);\nAO();" },
            'lv1': { name: "‡∏î‡πà‡∏≤‡∏ô 1: ‡πÑ‡∏õ‡∏ß‡∏¥‡∏®‡∏ß‡∏∞", hint: "‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 3500ms ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≠‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î", code: "FD(50); delay(3500);\nSL(40); delay(1200);\nFD(50); delay(3000);\nAO();" },
            'lv2': { name: "‡∏î‡πà‡∏≤‡∏ô 2: ‡πÑ‡∏õ‡∏ß‡∏¥‡∏ó‡∏¢‡πå", hint: "‡∏ó‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏¢‡∏≤‡∏ß‡πÜ ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ", code: "FD(50); delay(5000);\nAO();" },
            'lv3': { name: "‡∏î‡πà‡∏≤‡∏ô 3: ‡πÑ‡∏õ‡πÅ‡∏û‡∏ó‡∏¢‡πå", hint: "‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤ -> ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢ -> ‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤", code: "FD(50); delay(2000);\nSL(50); delay(1000);\nFD(50); delay(3000);\nAO();" },
            'lv4': { name: "‡∏î‡πà‡∏≤‡∏ô 4: ‡πÑ‡∏õ‡πÄ‡∏Å‡∏©‡∏ï‡∏£", hint: "‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡πÜ ‡∏î‡πà‡∏≤‡∏ô 2 ‡πÅ‡∏ï‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏Ç‡∏ß‡∏≤ (SR) ‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö", code: "FD(50); delay(5000);\nSR(50); delay(1000);\nFD(50); delay(3000);\nAO();" },
            'lv5': { name: "‡∏î‡πà‡∏≤‡∏ô 5: ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏î‡πà‡∏ß‡∏ô", hint: "‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°! ‡∏Å‡∏≤‡∏á‡πÅ‡∏Ç‡∏ô (90) ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏≤‡∏Ç‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏´‡∏ô‡∏µ‡∏ö (20)", code: "servo(1, 90);\nFD(30); delay(800); AO();\nservo(1, 20); delay(500);\nFD(50); delay(3000);\nSL(40); delay(1200);\nFD(50); delay(3000);\nAO();\nservo(1, 90);" },
            'lv6': { name: "‡∏î‡πà‡∏≤‡∏ô 6: ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á", hint: "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Ñ‡∏ö! ‡∏Ñ‡∏µ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á (BK) ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß", code: "servo(1, 90);\nFD(30); delay(800); AO();\nservo(1, 20); delay(500);\nBK(40); delay(1500);\nSL(50); delay(1000);\nFD(50); delay(3000);\nAO();" },
            'lv7': { name: "‡∏î‡πà‡∏≤‡∏ô 7: Loop", hint: "‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°: ‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤-‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥ 4 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á", code: "FD(50); delay(4000); SL(50); delay(1000);\nFD(40); delay(2000); SL(50); delay(1000);\nFD(50); delay(4000); SL(50); delay(1000);\nFD(40); delay(2000); AO();" },
            'lv8': { name: "‡∏î‡πà‡∏≤‡∏ô 8: Checkpoint", hint: "‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏∏‡∏î Checkpoint ‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡∏¢", code: "FD(40); delay(1500);\nSR(50); delay(1000);\nFD(50); delay(4000);\nAO();" },
            'lv9': { name: "‡∏î‡πà‡∏≤‡∏ô 9: ‡∏ñ‡∏≠‡∏¢‡∏à‡∏≠‡∏î", hint: "‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Ñ‡∏∑‡∏≠ ‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏ï‡∏±‡πâ‡∏á‡∏•‡∏≥ -> ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß -> ‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏¢‡∏≤‡∏ß‡πÜ", code: "FD(30); delay(1500);\nSL(50); delay(1000);\nBK(30); delay(3000);\nAO();" },
            'lv10': { name: "‡∏î‡πà‡∏≤‡∏ô 10: Full Mission", hint: "‡∏á‡∏≤‡∏ô‡∏´‡∏¥‡∏ô! ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î A -> ‡∏™‡πà‡∏á‡∏à‡∏∏‡∏î B -> ‡∏£‡∏±‡∏ö‡∏à‡∏∏‡∏î C -> ‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô", code: "// Mission Start\nFD(50); delay(3500); SL(50); delay(800); FD(40); delay(1500); AO();\nservo(1,90); delay(500); FD(20); delay(500); AO(); servo(1,20); delay(500);\nBK(40); delay(2000); SR(50); delay(800); FD(50); delay(2000); AO();\nSL(50); delay(800); FD(30); delay(1000); AO(); servo(1,90); delay(500); BK(30); delay(1000);\nSR(50); delay(800); FD(50); delay(3000); AO();\nSL(50); delay(800); FD(30); delay(1000); AO(); servo(1,20); delay(500);\nBK(30); delay(1000); SL(50); delay(800); FD(50); delay(4000); AO(); servo(1,90);" },
            'lv11': { name: "‡∏î‡πà‡∏≤‡∏ô 11: Slalom", hint: "‡πÇ‡∏¢‡∏Å‡∏ã‡πâ‡∏≤‡∏¢ ‡πÇ‡∏¢‡∏Å‡∏Ç‡∏ß‡∏≤ ‡∏™‡∏•‡∏±‡∏ö‡∏ü‡∏±‡∏ô‡∏õ‡∏•‡∏≤ ‡∏´‡∏•‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á", code: "FD(50); delay(1000); SL(40); delay(500);\nFD(50); delay(1000); SR(40); delay(500);\nFD(50); delay(1000); SL(40); delay(500);\nFD(50); delay(1000); SR(40); delay(500);\nFD(50); delay(1500); AO();" },
            'lv12': { name: "‡∏î‡πà‡∏≤‡∏ô 12: U-Turn", hint: "‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏±‡∏ö‡∏£‡∏ñ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß 180 ‡∏≠‡∏á‡∏®‡∏≤ (‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß 90 ‡∏™‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á)", code: "FD(50); delay(2000);\nSL(60); delay(800); FD(30); delay(1000);\nSL(60); delay(800);\nFD(50); delay(2000); AO();" },
            'lv13': { name: "‡∏î‡πà‡∏≤‡∏ô 13: Figure 8", hint: "‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç 8: ‡∏ß‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ 1 ‡∏£‡∏≠‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏ô‡∏Ç‡∏ß‡∏≤ 1 ‡∏£‡∏≠‡∏ö", code: "FD(50); delay(2000); SL(50); delay(1200);\nFD(40); delay(1500); SL(50); delay(1200);\nFD(50); delay(2000); SR(50); delay(1200);\nFD(40); delay(1500); SR(50); delay(1200); AO();" },
            'lv14': { name: "‡∏î‡πà‡∏≤‡∏ô 14: Spiral", hint: "‡πÄ‡∏î‡∏¥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á ‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ", code: "FD(60); delay(3000); SL(50); delay(800);\nFD(50); delay(2500); SL(50); delay(800);\nFD(40); delay(2000); SL(50); delay(800);\nFD(30); delay(1500); SL(50); delay(800); AO();" },
            'lv15': { name: "‡∏î‡πà‡∏≤‡∏ô 15: Long Reverse", hint: "‡∏Ç‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏¢‡∏≤‡∏ß‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏±‡∏Å‡∏û‡∏ß‡∏á‡∏°‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≠‡∏î", code: "BK(50); delay(4000);\nmotor(1, -30); motor(2, -60); delay(1500);\nBK(30); delay(1000); AO();" },
            'lv16': { name: "‡∏î‡πà‡∏≤‡∏ô 16: Multi-Drop", hint: "‡πÅ‡∏ß‡∏∞ 3 ‡∏à‡∏∏‡∏î: ‡∏Ñ‡∏µ‡∏ö -> ‡∏ß‡∏≤‡∏á -> ‡∏Ñ‡∏µ‡∏ö", code: "servo(1, 90); FD(30); delay(500); AO(); servo(1, 20); delay(500);\nFD(50); delay(2000); AO(); servo(1, 90); delay(500); BK(20); delay(500);\nSR(50); delay(800); FD(50); delay(2000); AO();\nSL(50); delay(800); FD(40); delay(1500); AO();" },
            'lv17': { name: "‡∏î‡πà‡∏≤‡∏ô 17: Perimeter", hint: "‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏•‡∏≤‡∏∞‡∏Ç‡∏≠‡∏ö‡∏™‡∏ô‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏£‡∏≠‡∏ö", code: "FD(80); delay(4000); SL(50); delay(900);\nFD(80); delay(3000); SL(50); delay(900);\nFD(80); delay(4000); SL(50); delay(900);\nFD(80); delay(3000); AO();" },
            'lv18': { name: "‡∏î‡πà‡∏≤‡∏ô 18: Staircase", hint: "‡πÄ‡∏î‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ö‡∏±‡∏ô‡πÑ‡∏î: ‡∏Ç‡∏ß‡∏≤-‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤-‡∏ã‡πâ‡∏≤‡∏¢", code: "FD(40); delay(1000); SR(50); delay(800);\nFD(40); delay(1000); SL(50); delay(800);\nFD(40); delay(1000); SR(50); delay(800);\nFD(40); delay(1000); SL(50); delay(800); AO();" },
            'lv19': { name: "‡∏î‡πà‡∏≤‡∏ô 19: 360 Spin", hint: "‡∏´‡∏°‡∏∏‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà (‡∏•‡πâ‡∏≠‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡∏•‡πâ‡∏≠‡∏Ç‡∏ß‡∏≤‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á)", code: "FD(50); delay(2000);\nmotor(1, 60); motor(2, -60); delay(2500);\nFD(50); delay(2000); AO();" },
            'lv20': { name: "‡∏î‡πà‡∏≤‡∏ô 20: FINAL", hint: "‡∏ö‡∏ó‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏™‡∏Å‡∏¥‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô!", code: "FD(60); delay(2000); SL(50); delay(800);\nFD(40); delay(1500); motor(1, -40); motor(2, -20); delay(1500);\nBK(30); delay(1000); FD(100); delay(1500); AO();" }
        };

        // --- 2. Code Autocomplete System ---
        const keywords = [
            { text: 'FD(50);', desc: '‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤' }, { text: 'BK(50);', desc: '‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á' },
            { text: 'SL(50);', desc: '‡∏´‡∏°‡∏∏‡∏ô‡∏ã‡πâ‡∏≤‡∏¢' }, { text: 'SR(50);', desc: '‡∏´‡∏°‡∏∏‡∏ô‡∏Ç‡∏ß‡∏≤' },
            { text: 'AO();', desc: '‡∏´‡∏¢‡∏∏‡∏î‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå' }, { text: 'delay(1000);', desc: '‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (ms)' },
            { text: 'servo(1, 90);', desc: '‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÇ‡∏ß (‡∏ä‡πà‡∏≠‡∏á, ‡∏≠‡∏á‡∏®‡∏≤)' }, { text: 'oled.text(0,0,"");', desc: '‡∏à‡∏≠‡∏†‡∏≤‡∏û' }
        ];
        const editorArea = document.getElementById('codeEditor');
        const suggestionBox = document.getElementById('suggestionBox');
        
        editorArea.addEventListener('input', () => {
            const text = editorArea.value;
            const cursor = editorArea.selectionStart;
            let start = cursor - 1;
            while(start >= 0 && /[a-zA-Z0-9_]/.test(text[start])) start--;
            start++;
            const word = text.substring(start, cursor).toLowerCase();
            
            if(word.length < 1) { suggestionBox.style.display = 'none'; return; }
            const matches = keywords.filter(k => k.text.toLowerCase().startsWith(word));
            
            if(matches.length > 0) {
                suggestionBox.innerHTML = matches.map(m => 
                    `<div class="suggestion-item" onclick="insertSuggestion('${m.text}', ${start}, ${cursor})">
                        <span class="font-bold text-blue-400">${m.text}</span><span class="text-gray-500">${m.desc}</span>
                    </div>`
                ).join('');
                // Simple positioning logic
                const rect = editorArea.getBoundingClientRect();
                suggestionBox.style.top = (rect.top + 60) + 'px'; // Approx
                suggestionBox.style.left = (rect.left + 60) + 'px';
                suggestionBox.style.display = 'block';
            } else { suggestionBox.style.display = 'none'; }
        });

        function insertSuggestion(text, start, end) {
            const val = editorArea.value;
            editorArea.value = val.substring(0, start) + text + val.substring(end);
            suggestionBox.style.display = 'none'; editorArea.focus();
        }
        function insertCode(code) {
            const start = editorArea.selectionStart;
            editorArea.value = editorArea.value.substring(0, start) + code + editorArea.value.substring(editorArea.selectionEnd);
            editorArea.focus();
        }

        // --- 3. Core Simulator Logic ---
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const oled = document.getElementById('oledScreen');
        let isRunning=false, animationFrame, commandQueue=[], currentCmdIndex=0, cmdStartTime=0;
        
        // Robot & Map
        const WORLD_W = 2400, WORLD_H = 1800;
        let camera = { x: WORLD_W/2, y: WORLD_H/2, scale: 0.5 };
        let robot = { x: 0, y: 0, angle: 0, speedL: 0, speedR: 0, servoAngle: 90, holdingObject: null };
        let currentLevel = 'lv1';
        let cans=[], targetZones=[], checkpoints=[], currentCheckpointIndex=0;

        // Init
        window.addEventListener('resize', resizeCanvas);
        function resizeCanvas() { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; draw(); }
        
        // Touch & Mouse Handling
        let isDragging=false, lastMouse={x:0, y:0};
        
        function handleStart(x, y) { isDragging=true; lastMouse={x, y}; }
        function handleMove(x, y) {
            if(isDragging) {
                camera.x -= (x - lastMouse.x)/camera.scale;
                camera.y -= (y - lastMouse.y)/camera.scale;
                lastMouse = {x, y};
                draw();
            }
        }
        function handleEnd() { isDragging=false; }

        canvas.addEventListener('mousedown', e => handleStart(e.clientX, e.clientY));
        window.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('mousemove', e => handleMove(e.clientX, e.clientY));
        
        // Touch events for mobile/tablet
        canvas.addEventListener('touchstart', e => {
            if(e.touches.length === 1) {
                handleStart(e.touches[0].clientX, e.touches[0].clientY);
                e.preventDefault();
            }
        }, {passive: false});
        canvas.addEventListener('touchmove', e => {
            if(e.touches.length === 1) {
                handleMove(e.touches[0].clientX, e.touches[0].clientY);
                e.preventDefault();
            }
        }, {passive: false});
        canvas.addEventListener('touchend', handleEnd);

        canvas.addEventListener('wheel', e => {
            e.preventDefault();
            const z = e.deltaY > 0 ? 0.9 : 1.1;
            camera.scale *= z; draw();
        }, {passive:false});

        function resetCamera() { camera.scale = 0.5; camera.x = WORLD_W/2; camera.y = WORLD_H/2; draw(); }
        function zoomIn() { camera.scale *= 1.2; draw(); }
        function zoomOut() { camera.scale /= 1.2; draw(); }

        // --- 4. Mission Logic & Level Loading ---
        function loadLevel(lv) {
            currentLevel = lv;
            resetSimulationLogic(); // Stop engine
            
            // Default Start
            let startX = WORLD_W/2, startY = WORLD_H*0.95, startAngle = -Math.PI/2;
            cans=[]; targetZones=[]; checkpoints=[]; currentCheckpointIndex=0;
            
            // Map Coordinates
            const w=WORLD_W, h=WORLD_H;
            const loc = { eng:{x:w*0.15,y:h*0.2}, sci:{x:w*0.48,y:h*0.15}, med:{x:w*0.45,y:h*0.75}, agri:{x:w*0.82,y:h*0.2}, park:{x:w*0.85,y:h*0.85} };

            // Level Config (Same logic)
            if(lv === 'lv1') targetZones.push({x:loc.eng.x, y:loc.eng.y, w:400, h:300, type:'stop', active:true});
            else if(lv === 'lv2') targetZones.push({x:loc.sci.x, y:loc.sci.y, w:400, h:300, type:'stop', active:true});
            else if(lv === 'lv3') targetZones.push({x:loc.med.x, y:loc.med.y, w:400, h:300, type:'stop', active:true});
            else if(lv === 'lv4') targetZones.push({x:loc.agri.x, y:loc.agri.y, w:400, h:300, type:'stop', active:true});
            else if(lv === 'lv5') { cans.push({id:1, x:startX, y:startY-200, color:'orange', radius:20}); targetZones.push({x:loc.eng.x, y:loc.eng.y, w:400, h:300, type:'drop', active:true}); }
            else if(lv === 'lv6') { startX=loc.sci.x; startY=loc.sci.y+200; cans.push({id:1, x:loc.sci.x, y:loc.sci.y, color:'blue', radius:20}); targetZones.push({x:loc.med.x, y:loc.med.y, w:400, h:300, type:'drop', active:true}); }
            else if(lv === 'lv7') { checkpoints=[{x:w*0.2,y:h*0.45,r:150}, {x:w*0.5,y:h*0.1,r:150}, {x:w*0.8,y:h*0.45,r:150}, {x:w*0.5,y:h*0.9,r:150}]; }
            else if(lv === 'lv8') { startX=loc.sci.x; startY=loc.sci.y+100; targetZones.push({x:loc.agri.x, y:loc.agri.y, w:400, h:300, type:'stop', active:true}); }
            else if(lv === 'lv9') { startX=loc.agri.x; startY=loc.agri.y+300; startAngle=Math.PI/2; targetZones.push({x:loc.park.x, y:loc.park.y, w:300, h:400, type:'stop', active:true}); }
            else if(lv === 'lv10') { cans.push({id:1,x:loc.eng.x,y:loc.eng.y+200,color:'red',radius:20}); cans.push({id:2,x:loc.agri.x,y:loc.agri.y+200,color:'green',radius:20}); targetZones.push({x:loc.park.x, y:loc.park.y, w:300, h:400, type:'stop', active:true}); }
            else if(lv === 'lv11') checkpoints=[{x:w*0.25,y:h*0.75,r:80},{x:w*0.35,y:h*0.6,r:80},{x:w*0.25,y:h*0.45,r:80},{x:w*0.35,y:h*0.3,r:80}];
            else if(lv === 'lv12') { startX=w*0.75; startY=h*0.8; targetZones.push({x:w*0.75, y:h*0.85, w:150, h:150, type:'stop', active:true}); }
            else if(lv === 'lv16') { cans.push({id:1,x:startX,y:startY-150,color:'red',radius:20}); cans.push({id:2,x:loc.sci.x,y:loc.sci.y+150,color:'blue',radius:20}); targetZones.push({x:loc.med.x, y:loc.med.y, w:400, h:300, type:'drop', active:true}); }
            
            // Set Robot
            robot.x = startX; robot.y = startY; robot.angle = startAngle;
            
            // Set Editor Default
            const template = `#include <POP32.h>\n\nvoid setup() {\n  oled.text(0, 0, "Mission: ${lv}");\n}\n\nvoid loop() {\n  // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà\n  \n}`;
            editorArea.value = template;
            
            document.getElementById('missionText').innerText = levelData[lv]?.name || "Custom Mission";
            document.getElementById('missionBox').classList.remove('hidden');
            document.getElementById('successOverlay').classList.add('hidden');
            document.getElementById('successOverlay').classList.remove('flex');
            
            draw();
        }

        document.getElementById('missionSelect').addEventListener('change', (e) => loadLevel(e.target.value));

        // --- 5. Simulation Engine ---
        function parseCode(src) {
            const lines = src.split('\n');
            const cmds = [];
            lines.forEach((l, i) => {
                l = l.split('//')[0].trim();
                if (!l || l.startsWith('#') || l.startsWith('void') || l === '{' || l === '}') return;
                
                let match = l.match(/([a-zA-Z0-9_.]+)\((.*)\);?/);
                if (match) {
                    let c = match[1].toLowerCase();
                    let args = [];
                    if(match[2].includes('"')) {
                        let str = match[2].match(/"([^"]+)"/);
                        if(str) args.push(str[1]);
                        let num = match[2].split(',')[0].trim();
                        if(!isNaN(num)) args.unshift(parseInt(num));
                    } else {
                        args = match[2].split(',').map(s => parseFloat(s.trim()));
                    }
                    if(c==='delay') c='sleep';
                    cmds.push({type:c, args:args, line:i+1});
                }
            });
            cmds.push({type:'ao', args:[]});
            return cmds;
        }

        function runSimulation() {
            if(isRunning) return;
            commandQueue = parseCode(editorArea.value);
            if(commandQueue.length === 0) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ô"); return; }
            
            isRunning = true;
            currentCmdIndex = 0;
            cmdStartTime = 0;
            lastTimestamp = performance.now();
            
            document.getElementById('runBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span class="hidden sm:inline">Running...</span>';
            document.getElementById('statusIndicator').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> RUN';
            
            requestAnimationFrame(gameLoop);
        }

        function resetSimulationLogic() {
            isRunning = false;
            cancelAnimationFrame(animationFrame);
            robot.speedL = 0; robot.speedR = 0;
            updateDashboard();
            document.getElementById('runBtn').innerHTML = '<i class="fas fa-play"></i> <span id="runBtnText">Upload & Run</span>';
            document.getElementById('statusIndicator').innerHTML = '<span class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></span> READY';
        }
        
        function resetSimulation() {
            resetSimulationLogic();
            loadLevel(currentLevel); // Reload positions
        }

        function gameLoop(ts) {
            if(!isRunning) return;
            const dt = (ts - lastTimestamp) / 1000;
            lastTimestamp = ts;

            if(currentCmdIndex < commandQueue.length) {
                const cmd = commandQueue[currentCmdIndex];
                if(cmdStartTime === 0) { cmdStartTime = ts; executeCommand(cmd); }
                
                if(cmd.type === 'sleep') {
                    if(ts - cmdStartTime >= cmd.args[0]) { currentCmdIndex++; cmdStartTime = 0; }
                } else {
                    currentCmdIndex++; cmdStartTime = 0;
                }
            } else {
                isRunning = false;
                robot.speedL = 0; robot.speedR = 0; updateDashboard();
                document.getElementById('runBtn').innerHTML = '<i class="fas fa-check"></i> Done';
                setTimeout(() => document.getElementById('runBtn').innerHTML = '<i class="fas fa-play"></i> <span id="runBtnText">Upload & Run</span>', 1500);
            }

            updatePhysics(dt);
            draw();
            if(isRunning) animationFrame = requestAnimationFrame(gameLoop);
        }

        function executeCommand(cmd) {
            switch(cmd.type) {
                case 'fd': robot.speedL = cmd.args[0]; robot.speedR = cmd.args[0]; break;
                case 'bk': robot.speedL = -cmd.args[0]; robot.speedR = -cmd.args[0]; break;
                case 'sl': robot.speedL = -cmd.args[0]; robot.speedR = cmd.args[0]; break;
                case 'sr': robot.speedL = cmd.args[0]; robot.speedR = -cmd.args[0]; break;
                case 'ao': robot.speedL = 0; robot.speedR = 0; break;
                case 'servo': robot.servoAngle = cmd.args[1] !== undefined ? cmd.args[1] : cmd.args[0]; checkGrab(); break;
                case 'oled.text': if(cmd.args[0]===0) oled.innerText = cmd.args[2]; else oled.innerText += "\n" + cmd.args[2]; break;
            }
            updateDashboard();
        }

        function updatePhysics(dt) {
            const spd = 3.5;
            let v = (robot.speedL + robot.speedR) * spd / 2;
            let rot = (robot.speedR - robot.speedL) / 40 * 0.8;
            robot.x += Math.cos(robot.angle)*v*dt;
            robot.y += Math.sin(robot.angle)*v*dt;
            robot.angle += rot*dt;
            
            // Hold Object
            if(robot.holdingObject) {
                robot.holdingObject.x = robot.x + Math.cos(robot.angle)*40;
                robot.holdingObject.y = robot.y + Math.sin(robot.angle)*40;
            }
            
            checkGoals();
        }

        function checkGrab() {
            if(robot.servoAngle <= 45 && !robot.holdingObject) {
                const reach = 60;
                const gx = robot.x + Math.cos(robot.angle)*40;
                const gy = robot.y + Math.sin(robot.angle)*40;
                let found = cans.find(c => !c.grabbed && Math.hypot(c.x-gx, c.y-gy) < reach);
                if(found) { found.grabbed = true; robot.holdingObject = found; playTone(1000, 100); }
            } else if(robot.servoAngle >= 80 && robot.holdingObject) {
                robot.holdingObject.grabbed = false;
                robot.holdingObject = null;
            }
        }

        function checkGoals() {
            // Checkpoints
            if(checkpoints.length > 0) {
                if(currentCheckpointIndex < checkpoints.length) {
                    let cp = checkpoints[currentCheckpointIndex];
                    if(Math.hypot(robot.x - cp.x, robot.y - cp.y) < cp.r) {
                        currentCheckpointIndex++; playTone(600, 100);
                        if(currentCheckpointIndex >= checkpoints.length) showSuccess();
                    }
                }
                return;
            }
            // Zones
            targetZones.forEach(z => {
                if(!z.active) return;
                let inZone = (robot.x > z.x - z.w/2 && robot.x < z.x + z.w/2 && robot.y > z.y - z.h/2 && robot.y < z.y + z.h/2);
                if(inZone) {
                    if(z.type === 'stop' && Math.abs(robot.speedL) < 5 && Math.abs(robot.speedR) < 5) showSuccess();
                    else if(z.type === 'drop') {
                        let itemIn = cans.some(c => !c.grabbed && c.x > z.x - z.w/2 && c.x < z.x + z.w/2 && c.y > z.y - z.h/2 && c.y < z.y + z.h/2);
                        if(itemIn) showSuccess();
                    }
                }
            });
        }

        function showSuccess() {
            isRunning = false;
            document.getElementById('successOverlay').classList.remove('hidden');
            document.getElementById('successOverlay').classList.add('flex');
            playTone(800, 100); setTimeout(() => playTone(1200, 400), 150);
        }
        function closeSuccess() { document.getElementById('successOverlay').classList.add('hidden'); document.getElementById('successOverlay').classList.remove('flex'); }
        function nextLevel() {
            let sel = document.getElementById('missionSelect');
            if(sel.selectedIndex < sel.options.length - 1) {
                sel.selectedIndex++; sel.dispatchEvent(new Event('change'));
            }
            closeSuccess();
        }

        function updateDashboard() {
            document.getElementById('motorL').innerText = Math.round(robot.speedL);
            document.getElementById('motorR').innerText = Math.round(robot.speedR);
            document.getElementById('servoVal').innerText = robot.servoAngle + "¬∞";
        }
        function playTone(f, d) {
            try {
                const AC = window.AudioContext || window.webkitAudioContext;
                const ac = new AC();
                const osc = ac.createOscillator();
                const g = ac.createGain();
                osc.type = 'square'; osc.frequency.value = f; g.gain.value = 0.05;
                osc.connect(g); g.connect(ac.destination);
                osc.start(); setTimeout(() => osc.stop(), d);
            } catch(e) {}
        }

        function draw() {
            ctx.setTransform(1, 0, 0, 1, 0, 0); ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Camera
            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.scale(camera.scale, camera.scale);
            ctx.translate(-camera.x, -camera.y);

            // Draw Map
            const w=WORLD_W, h=WORLD_H;
            ctx.fillStyle='#f9fafb'; ctx.fillRect(0,0,w,h);
            ctx.strokeStyle='#9ca3af'; ctx.lineWidth=10; ctx.strokeRect(0,0,w,h);
            
            // Roads
            ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=100; ctx.strokeStyle='#374151';
            ctx.beginPath();
            ctx.moveTo(w*0.25, h*0.2); ctx.lineTo(w*0.25, h*0.8); ctx.lineTo(w*0.75, h*0.8); ctx.lineTo(w*0.75, h*0.2); ctx.lineTo(w*0.25, h*0.2);
            ctx.moveTo(w*0.25, h*0.5); ctx.lineTo(w*0.75, h*0.5);
            ctx.moveTo(w*0.5, h*0.2); ctx.lineTo(w*0.5, h*0.5);
            ctx.moveTo(w*0.5, h*0.8); ctx.lineTo(w*0.5, h*0.95);
            ctx.stroke();
            
            // Dashed Line
            ctx.lineWidth=4; ctx.strokeStyle='#ffffff'; ctx.setLineDash([30, 40]); ctx.stroke(); ctx.setLineDash([]);

            // Buildings
            function drawB(x,y,w,h,c,t) {
                ctx.fillStyle=c; ctx.fillRect(x,y,w,h);
                ctx.strokeStyle='rgba(0,0,0,0.1)'; ctx.lineWidth=4; ctx.strokeRect(x,y,w,h);
                ctx.fillStyle='#1f2937'; ctx.font='bold 36px Prompt'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(t, x+w/2, y+h/2);
            }
            drawB(w*0.1, h*0.1, w*0.2, h*0.3, '#fca5a5', '‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°');
            drawB(w*0.4, h*0.05, w*0.2, h*0.25, '#fde047', '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå');
            drawB(w*0.7, h*0.1, w*0.2, h*0.3, '#86efac', '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå');
            drawB(w*0.35, h*0.6, w*0.3, h*0.15, '#93c5fd', '‡πÅ‡∏û‡∏ó‡∏¢‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå');
            
            // Zones
            targetZones.forEach(z => {
                if(!z.active) return;
                const p = Math.sin(Date.now()/200)*0.2 + 0.4;
                ctx.fillStyle = z.type==='drop' ? `rgba(16,185,129,${p})` : `rgba(239,68,68,${p})`;
                ctx.fillRect(z.x-z.w/2, z.y-z.h/2, z.w, z.h);
                ctx.strokeStyle = z.type==='drop'?'#10b981':'#ef4444'; ctx.lineWidth=4; ctx.strokeRect(z.x-z.w/2, z.y-z.h/2, z.w, z.h);
                ctx.fillStyle='#000'; ctx.font='bold 30px Prompt'; ctx.fillText(z.type==='drop'?'‡∏à‡∏∏‡∏î‡∏ß‡∏≤‡∏á':'‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢', z.x, z.y);
            });

            // Checkpoints
            checkpoints.forEach((cp, i) => {
                ctx.beginPath(); ctx.arc(cp.x, cp.y, cp.r, 0, Math.PI*2);
                ctx.fillStyle = i===currentCheckpointIndex ? 'rgba(239,68,68,0.3)' : 'rgba(200,200,200,0.2)'; ctx.fill();
                ctx.strokeStyle = i===currentCheckpointIndex ? 'red' : 'gray'; ctx.lineWidth=4; ctx.stroke();
                ctx.fillStyle='black'; ctx.font='bold 40px Arial'; ctx.fillText(i+1, cp.x, cp.y);
            });

            // Cans
            cans.forEach(c => {
                if(!c.grabbed) {
                    ctx.fillStyle=c.color; ctx.beginPath(); ctx.arc(c.x, c.y, c.radius, 0, Math.PI*2); ctx.fill();
                    ctx.strokeStyle='rgba(0,0,0,0.5)'; ctx.lineWidth=2; ctx.stroke();
                }
            });

            // Robot
            ctx.save(); ctx.translate(robot.x, robot.y); ctx.rotate(robot.angle);
            // Gripper
            const va = (robot.servoAngle/90)*(Math.PI/4);
            ctx.strokeStyle='#4b5563'; ctx.lineWidth=8;
            ctx.beginPath(); ctx.moveTo(20,-15); ctx.lineTo(20+30*Math.cos(va), -15-30*Math.sin(va)); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(20,15); ctx.lineTo(20+30*Math.cos(va), 15+30*Math.sin(va)); ctx.stroke();
            if(robot.holdingObject) {
                ctx.fillStyle=robot.holdingObject.color; ctx.beginPath(); ctx.arc(35,0,robot.holdingObject.radius,0,Math.PI*2); ctx.fill();
            }
            // Body
            ctx.fillStyle='#4f46e5'; ctx.beginPath(); ctx.roundRect(-25,-25,50,50,10); ctx.fill();
            // Wheels
            ctx.fillStyle='#1f2937'; ctx.fillRect(-15,-32,30,8); ctx.fillRect(-15,24,30,8);
            // LED
            ctx.fillStyle='#fbbf24'; ctx.beginPath(); ctx.moveTo(10,0); ctx.lineTo(-5,-8); ctx.lineTo(-5,8); ctx.fill();
            ctx.restore();
        }

        // --- 6. AI & Manual UI Logic ---
        function openAI() {
            document.getElementById('aiModal').classList.remove('hidden');
            const chat = document.getElementById('aiChatContent');
            chat.innerHTML = `
                <div class="bg-indigo-900/50 text-indigo-100 p-3 rounded-lg border border-indigo-700/50 text-sm">
                    <i class="fas fa-robot mr-2"></i> ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <strong>${levelData[currentLevel]?.name}</strong> ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö?
                </div>
            `;
        }
        function closeAI() { document.getElementById('aiModal').classList.add('hidden'); }
        function openManual() { document.getElementById('manualModal').classList.remove('hidden'); }
        function closeManual() { document.getElementById('manualModal').classList.add('hidden'); }

        function addAiMessage(msg, isUser) {
            const chat = document.getElementById('aiChatContent');
            const div = document.createElement('div');
            div.className = isUser ? "ml-auto bg-blue-600 text-white p-2 rounded-lg text-sm max-w-[80%] rounded-tr-none" : "mr-auto bg-gray-700 text-gray-200 p-2 rounded-lg text-sm max-w-[80%] rounded-tl-none border border-gray-600";
            div.innerHTML = msg;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function aiGetHint() {
            addAiMessage("‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö", true);
            setTimeout(() => {
                const hint = levelData[currentLevel]?.hint || "‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ ‡∏•‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏π‡∏ô‡∏∞!";
                addAiMessage(`<i class="fas fa-lightbulb text-yellow-400"></i> ${hint}`, false);
            }, 600);
        }

        function aiCheckCode() {
            addAiMessage("‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢", true);
            setTimeout(() => {
                const code = document.getElementById('codeEditor').value;
                let msg = "‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡∏π‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏•‡∏≠‡∏á‡∏Å‡∏î Run ‡πÄ‡∏•‡∏¢!";
                if(!code.includes("AO()")) msg = "‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á! ‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á <code>AO();</code> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏∏‡πà‡∏ô‡∏ï‡∏≠‡∏ô‡∏à‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤?";
                else if(!code.includes("delay")) msg = "‚ö†Ô∏è ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà <code>delay(ms);</code> ‡πÉ‡∏´‡πâ‡∏´‡∏∏‡πà‡∏ô‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö";
                else if(currentLevel === 'lv5' && !code.includes("servo")) msg = "‚ö†Ô∏è ‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏µ‡∏ö‡∏Ç‡∏≠‡∏á ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á <code>servo()</code> ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö";
                addAiMessage(msg, false);
            }, 800);
        }

        function aiRevealSolution() {
            if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? (‡πÇ‡∏Ñ‡πâ‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ó‡∏±‡∏ö)")) {
                addAiMessage("‡∏Ç‡∏≠‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö", true);
                setTimeout(() => {
                    const sol = levelData[currentLevel]?.code;
                    if(sol) {
                        const fullCode = `#include <POP32.h>\n\nvoid setup() {\n  oled.text(0,0,"Solution Loaded");\n}\n\nvoid loop() {\n${sol}\n}`;
                        document.getElementById('codeEditor').value = fullCode;
                        addAiMessage("‚úÖ ‡∏ú‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏•‡∏¢‡∏•‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‡∏•‡∏≠‡∏á‡∏Å‡∏î Run ‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢", false);
                        // Auto close after 2s
                        setTimeout(closeAI, 2000);
                    } else {
                        addAiMessage("‚ùå ‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏â‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö", false);
                    }
                }, 800);
            }
        }

        // Start
        loadLevel('lv1');
        resizeCanvas();
    </script>
</body>
</html>
