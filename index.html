<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POP32i Simulator: Pro Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&family=Source+Code+Pro:wght@400;700&display=swap');
        
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f3f4f6;
            height: 100vh;
            overflow: hidden;
        }

        .code-font {
            font-family: 'Source Code Pro', monospace;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .canvas-bg {
            background-color: #e5e7eb;
            cursor: grab;
        }
        .canvas-bg:active { cursor: grabbing; }
        
        optgroup { font-weight: bold; color: #fbbf24; background-color: #3730a3; }
        option { color: white; background-color: #4338ca; }

        /* Autocomplete Styles */
        #suggestionBox {
            position: absolute;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 6px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            z-index: 50;
            max-height: 200px;
            overflow-y: auto;
            min-width: 150px;
            display: none;
        }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            color: #e5e7eb;
            font-family: 'Source Code Pro', monospace;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .suggestion-item:hover, .suggestion-item.active {
            background-color: #374151;
            color: #60a5fa;
        }
        .suggestion-desc {
            font-size: 10px;
            color: #9ca3af;
            margin-left: 10px;
        }

        /* Toolbar Button Hover */
        .cmd-btn:hover { transform: translateY(-1px); }
        .cmd-btn:active { transform: translateY(1px); }
    </style>
</head>
<body class="flex flex-col h-screen text-gray-800">

    <!-- Header -->
    <header class="bg-indigo-900 text-white p-3 shadow-md flex justify-between items-center shrink-0 z-20 border-b border-indigo-700">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center text-indigo-900 font-bold text-xl shadow-lg">
                <i class="fas fa-robot"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-yellow-400">POP32i Pro</h1>
                <p class="text-xs text-indigo-200">‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</p>
            </div>
        </div>
        <div class="flex gap-2 items-center">
            <div class="flex flex-col items-end mr-2">
                <label class="text-[10px] uppercase text-indigo-200 font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</label>
                <select id="missionSelect" class="bg-indigo-800 text-yellow-300 border border-indigo-500 rounded px-3 py-1 text-sm focus:outline-none w-64 font-medium shadow-inner">
                    <option value="free">üõ†Ô∏è ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏¥‡∏™‡∏£‡∏∞ (Free Run)</option>
                    <optgroup label="Beginner (‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô)">
                        <option value="lv1">‡∏î‡πà‡∏≤‡∏ô 1: ‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏ß‡∏¥‡∏®‡∏ß‡∏∞</option>
                        <option value="lv2">‡∏î‡πà‡∏≤‡∏ô 2: ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏•‡πÑ‡∏õ‡∏ß‡∏¥‡∏ó‡∏¢‡πå</option>
                        <option value="lv3">‡∏î‡πà‡∏≤‡∏ô 3: ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
                        <option value="lv4">‡∏î‡πà‡∏≤‡∏ô 4: ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏Ç‡∏ß‡∏≤‡πÑ‡∏õ‡πÄ‡∏Å‡∏©‡∏ï‡∏£</option>
                    </optgroup>
                    <optgroup label="Intermediate (‡∏Ñ‡∏µ‡∏ö‡∏Ç‡∏≠‡∏á)">
                        <option value="lv5">‡∏î‡πà‡∏≤‡∏ô 5: ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏î‡πà‡∏ß‡∏ô (Pick & Place)</option>
                        <option value="lv6">‡∏î‡πà‡∏≤‡∏ô 6: ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏ï‡∏∂‡∏Å</option>
                        <option value="lv7">‡∏î‡πà‡∏≤‡∏ô 7: ‡πÄ‡∏î‡∏¥‡∏ô‡∏ß‡∏ô Loop ‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°</option>
                        <option value="lv8">‡∏î‡πà‡∏≤‡∏ô 8: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏û‡∏≠‡∏¢‡∏ï‡πå</option>
                        <option value="lv9">‡∏î‡πà‡∏≤‡∏ô 9: ‡∏ñ‡∏≠‡∏¢‡∏à‡∏≠‡∏î</option>
                        <option value="lv10">‡∏î‡πà‡∏≤‡∏ô 10: ‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ (Full)</option>
                    </optgroup>
                    <optgroup label="Expert (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏ó‡∏û)">
                        <option value="lv11">‡∏î‡πà‡∏≤‡∏ô 11: ‡∏ã‡∏¥‡∏Å‡πÅ‡∏ã‡∏Å (Slalom)</option>
                        <option value="lv12">‡∏î‡πà‡∏≤‡∏ô 12: ‡∏Å‡∏•‡∏±‡∏ö‡∏£‡∏ñ‡∏ï‡∏±‡∏ß U</option>
                        <option value="lv13">‡∏î‡πà‡∏≤‡∏ô 13: ‡πÄ‡∏•‡∏Ç 8</option>
                        <option value="lv14">‡∏î‡πà‡∏≤‡∏ô 14: ‡∏Å‡πâ‡∏ô‡∏´‡∏≠‡∏¢ (Spiral)</option>
                        <option value="lv15">‡∏î‡πà‡∏≤‡∏ô 15: ‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏¢‡∏≤‡∏ß</option>
                        <option value="lv16">‡∏î‡πà‡∏≤‡∏ô 16: ‡∏™‡πà‡∏á 3 ‡∏à‡∏∏‡∏î</option>
                        <option value="lv17">‡∏î‡πà‡∏≤‡∏ô 17: ‡∏£‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡∏≠‡∏á</option>
                        <option value="lv18">‡∏î‡πà‡∏≤‡∏ô 18: ‡∏ü‡∏±‡∏ô‡∏õ‡∏•‡∏≤</option>
                        <option value="lv19">‡∏î‡πà‡∏≤‡∏ô 19: 360 Spin</option>
                        <option value="lv20">‡∏î‡πà‡∏≤‡∏ô 20: FINAL EXAM</option>
                    </optgroup>
                </select>
            </div>
            <button onclick="openAI()" class="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 px-4 py-2 rounded-full text-sm transition h-full text-white shadow-lg flex items-center gap-2 border border-cyan-300">
                <i class="fas fa-sparkles"></i> AI Helper
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Left: Code Editor Area -->
        <div class="w-1/3 bg-gray-900 flex flex-col border-r border-gray-700 relative z-10 shadow-xl">
            <!-- File Tab -->
            <div class="bg-gray-800 text-gray-300 px-4 py-1 text-xs font-mono flex justify-between items-center border-b border-gray-700">
                <span><i class="fas fa-file-code mr-1 text-blue-400"></i> main.cpp</span>
                <span id="statusIndicator" class="text-yellow-500"><i class="fas fa-circle text-[8px] mr-1"></i>Ready</span>
            </div>

            <!-- Command Toolbar (Quick Insert) -->
            <div class="bg-gray-800 p-2 grid grid-cols-4 gap-1 border-b border-gray-700">
                <button onclick="insertCode('FD(50); ')" class="cmd-btn bg-gray-700 hover:bg-gray-600 text-green-400 text-xs py-1 rounded border border-gray-600 font-mono transition" title="‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤">FD</button>
                <button onclick="insertCode('BK(50); ')" class="cmd-btn bg-gray-700 hover:bg-gray-600 text-green-400 text-xs py-1 rounded border border-gray-600 font-mono transition" title="‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á">BK</button>
                <button onclick="insertCode('SL(50); ')" class="cmd-btn bg-gray-700 hover:bg-gray-600 text-yellow-400 text-xs py-1 rounded border border-gray-600 font-mono transition" title="‡∏´‡∏°‡∏∏‡∏ô‡∏ã‡πâ‡∏≤‡∏¢">SL</button>
                <button onclick="insertCode('SR(50); ')" class="cmd-btn bg-gray-700 hover:bg-gray-600 text-yellow-400 text-xs py-1 rounded border border-gray-600 font-mono transition" title="‡∏´‡∏°‡∏∏‡∏ô‡∏Ç‡∏ß‡∏≤">SR</button>
                
                <button onclick="insertCode('delay(1000); ')" class="cmd-btn bg-gray-700 hover:bg-gray-600 text-blue-300 text-xs py-1 rounded border border-gray-600 font-mono transition" title="‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤">Delay</button>
                <button onclick="insertCode('AO(); ')" class="cmd-btn bg-gray-700 hover:bg-gray-600 text-red-400 text-xs py-1 rounded border border-gray-600 font-mono transition" title="‡∏´‡∏¢‡∏∏‡∏î">AO</button>
                <button onclick="insertCode('servo(1, 90); ')" class="cmd-btn bg-gray-700 hover:bg-gray-600 text-purple-400 text-xs py-1 rounded border border-gray-600 font-mono transition" title="‡∏Å‡∏≤‡∏á/‡∏´‡∏∏‡∏ö ‡πÅ‡∏Ç‡∏ô">Servo</button>
                <button onclick="insertCode('oled.text(0,0,\"\"); ')" class="cmd-btn bg-gray-700 hover:bg-gray-600 text-cyan-400 text-xs py-1 rounded border border-gray-600 font-mono transition" title="‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°">OLED</button>
            </div>
            
            <!-- Editor with Autocomplete Container -->
            <div class="relative flex-1 overflow-hidden group">
                <textarea id="codeEditor" class="w-full h-full bg-gray-900 text-green-400 code-font p-4 outline-none resize-none text-sm leading-relaxed" spellcheck="false" placeholder="// ‡∏û‡∏¥‡∏°‡∏û‡πå 'F' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ Autocomplete..."></textarea>
                <!-- Autocomplete Popup -->
                <div id="suggestionBox"></div>
                <!-- Mirror div for cursor position calculation -->
                <div id="mirrorDiv" class="absolute top-0 left-0 w-full h-full p-4 text-sm leading-relaxed code-font whitespace-pre-wrap invisible pointer-events-none z-0"></div>
            </div>

            <!-- Bottom Controls -->
            <div class="p-4 bg-gray-800 border-t border-gray-700 flex gap-2">
                <button onclick="runSimulation()" id="runBtn" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-3 rounded-lg font-bold transition flex items-center justify-center gap-2 shadow-lg shadow-green-900/50">
                    <i class="fas fa-play"></i> Upload & Run
                </button>
                <button onclick="resetSimulation()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 rounded-lg font-bold transition shadow-lg">
                    <i class="fas fa-undo"></i>
                </button>
            </div>
        </div>

        <!-- Right: Simulation Area -->
        <div class="flex-1 flex flex-col relative bg-gray-100 overflow-hidden">
            <!-- HUD -->
            <div class="absolute top-4 left-4 z-10 flex gap-2 flex-wrap pointer-events-none">
                <div class="bg-white/90 backdrop-blur shadow-lg rounded-lg p-3 w-48 border border-gray-200 pointer-events-auto">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-1">OLED Display</div>
                    <div id="oledScreen" class="bg-black text-cyan-400 font-mono text-xs p-2 h-16 rounded overflow-hidden leading-tight whitespace-pre-wrap">POP32i Ready...</div>
                </div>
                <div class="bg-white/90 backdrop-blur shadow-lg rounded-lg p-3 border border-gray-200 flex flex-col justify-center min-w-[100px] pointer-events-auto">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-1">Status</div>
                    <div class="text-xs space-y-1">
                        <div><span class="font-bold text-gray-700">M1:</span> <span id="motorL" class="text-blue-600">0</span> <span class="font-bold text-gray-700 ml-1">M2:</span> <span id="motorR" class="text-blue-600">0</span></div>
                        <div><span class="font-bold text-gray-700">Servo:</span> <span id="servoVal" class="text-purple-600">90¬∞</span></div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="absolute bottom-6 right-6 z-10 flex flex-col gap-2">
                <button onclick="zoomIn()" class="w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center text-gray-600 hover:text-indigo-600 font-bold"><i class="fas fa-plus"></i></button>
                <button onclick="resetCamera()" class="w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center text-gray-600 hover:text-indigo-600"><i class="fas fa-compress"></i></button>
                <button onclick="zoomOut()" class="w-10 h-10 bg-white rounded-full shadow-lg flex items-center justify-center text-gray-600 hover:text-indigo-600 font-bold"><i class="fas fa-minus"></i></button>
            </div>

            <canvas id="simCanvas" class="w-full h-full canvas-bg block"></canvas>

            <!-- Mission Popup -->
            <div id="missionBox" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-white/95 backdrop-blur shadow-xl rounded-full px-6 py-3 border border-indigo-200 hidden items-center gap-3 animate-bounce z-20 pointer-events-none">
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600"><i class="fas fa-flag-checkered"></i></div>
                <div><div class="text-xs text-gray-500 font-bold uppercase">Current Mission</div><span id="missionText" class="text-sm font-semibold text-gray-800">Mission</span></div>
            </div>

            <!-- Success Overlay -->
            <div id="successOverlay" class="absolute inset-0 bg-black/80 hidden flex-col items-center justify-center text-white z-50 backdrop-blur-sm">
                <div class="text-6xl text-yellow-400 mb-4 animate-pulse"><i class="fas fa-star"></i></div>
                <h2 class="text-4xl font-bold mb-2">Mission Complete!</h2>
                <div class="flex gap-4 mt-8">
                    <button onclick="closeSuccess()" class="bg-gray-600 hover:bg-gray-500 px-6 py-2 rounded-full font-bold">‡πÄ‡∏•‡πà‡∏ô‡∏ã‡πâ‡∏≥</button>
                    <button onclick="nextLevel()" class="bg-indigo-600 hover:bg-indigo-500 px-8 py-2 rounded-full font-bold">‡∏î‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Modal -->
    <div id="aiModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden border border-cyan-200">
            <div class="bg-gradient-to-r from-indigo-900 to-indigo-800 p-4 flex items-center justify-between border-b border-indigo-700">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-cyan-400 rounded-full flex items-center justify-center text-indigo-900 font-bold text-xl shadow-inner animate-pulse"><i class="fas fa-robot"></i></div>
                    <div><h3 class="text-lg font-bold text-white">POP-AI Assistant</h3></div>
                </div>
                <button onclick="closeAI()" class="text-gray-400 hover:text-white transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 bg-gray-50 min-h-[200px]"><div id="aiChatContent" class="space-y-4"></div></div>
            <div class="p-4 bg-white border-t border-gray-100 grid grid-cols-1 gap-2">
                <button onclick="aiGetHint()" class="btn-ai bg-yellow-100 text-yellow-800 py-3 rounded-xl border border-yellow-200 font-bold">üí° ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ</button>
                <button onclick="aiCheckCode()" class="btn-ai bg-blue-100 text-blue-800 py-3 rounded-xl border border-blue-200 font-bold">üîç ‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏Ñ‡πâ‡∏î</button>
                <button onclick="aiRevealSolution()" class="btn-ai bg-red-50 text-red-800 py-2 rounded-xl border border-red-100 text-sm">üîì ‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢</button>
            </div>
        </div>
    </div>

    <!-- Audio -->
    <audio id="beepSound" src="data:audio/wav;base64,UklGRl9vT1dAVXphcnQAAAAAAAAAAAAAAABwY20gAAAAAGAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="></audio>

    <script>
        // --- Autocomplete System ---
        const keywords = [
            { text: 'FD(50);', desc: '‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤' },
            { text: 'BK(50);', desc: '‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á' },
            { text: 'SL(50);', desc: '‡∏´‡∏°‡∏∏‡∏ô‡∏ã‡πâ‡∏≤‡∏¢' },
            { text: 'SR(50);', desc: '‡∏´‡∏°‡∏∏‡∏ô‡∏Ç‡∏ß‡∏≤' },
            { text: 'AO();', desc: '‡∏´‡∏¢‡∏∏‡∏î‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå' },
            { text: 'delay(1000);', desc: '‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (ms)' },
            { text: 'servo(1, 90);', desc: '‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÇ‡∏ß (‡∏ä‡πà‡∏≠‡∏á, ‡∏≠‡∏á‡∏®‡∏≤)' },
            { text: 'motor(1, 50);', desc: '‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏¢‡∏Å (‡∏ä‡πà‡∏≠‡∏á, ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß)' },
            { text: 'oled.text(0,0,"");', desc: '‡∏à‡∏≠‡∏†‡∏≤‡∏û' },
            { text: 'void setup() {}', desc: '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤' },
            { text: 'void loop() {}', desc: '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏ô‡∏ã‡πâ‡∏≥' }
        ];

        const editorArea = document.getElementById('codeEditor');
        const suggestionBox = document.getElementById('suggestionBox');
        const mirrorDiv = document.getElementById('mirrorDiv');
        let selectedSuggestionIndex = 0;

        editorArea.addEventListener('input', updateSuggestions);
        editorArea.addEventListener('keydown', handleKeyNavigation);
        editorArea.addEventListener('click', () => suggestionBox.style.display = 'none');

        function insertCode(code) {
            const start = editorArea.selectionStart;
            const end = editorArea.selectionEnd;
            const text = editorArea.value;
            const before = text.substring(0, start);
            const after = text.substring(end, text.length);
            
            editorArea.value = before + code + after;
            editorArea.selectionStart = editorArea.selectionEnd = start + code.length;
            editorArea.focus();
            suggestionBox.style.display = 'none';
        }

        function updateSuggestions(e) {
            const text = editorArea.value;
            const cursor = editorArea.selectionStart;
            
            // Get word before cursor
            let start = cursor - 1;
            while (start >= 0 && /[a-zA-Z0-9_.]/.test(text[start])) {
                start--;
            }
            start++;
            
            const currentWord = text.substring(start, cursor);
            
            if (currentWord.length < 1) {
                suggestionBox.style.display = 'none';
                return;
            }

            const matches = keywords.filter(k => k.text.toLowerCase().startsWith(currentWord.toLowerCase()));

            if (matches.length > 0) {
                renderSuggestions(matches, start, cursor);
                positionSuggestionBox(cursor);
            } else {
                suggestionBox.style.display = 'none';
            }
        }

        function renderSuggestions(matches, wordStart, wordEnd) {
            suggestionBox.innerHTML = '';
            selectedSuggestionIndex = 0;
            
            matches.forEach((match, index) => {
                const div = document.createElement('div');
                div.className = `suggestion-item ${index === 0 ? 'active' : ''}`;
                div.innerHTML = `<span>${match.text}</span><span class="suggestion-desc">${match.desc}</span>`;
                div.onclick = () => {
                    const text = editorArea.value;
                    const before = text.substring(0, wordStart);
                    const after = text.substring(wordEnd);
                    editorArea.value = before + match.text + after;
                    editorArea.selectionStart = editorArea.selectionEnd = before.length + match.text.length;
                    suggestionBox.style.display = 'none';
                    editorArea.focus();
                };
                suggestionBox.appendChild(div);
            });
            suggestionBox.style.display = 'block';
        }

        function handleKeyNavigation(e) {
            if (suggestionBox.style.display !== 'block') return;

            const items = suggestionBox.getElementsByClassName('suggestion-item');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                items[selectedSuggestionIndex].classList.remove('active');
                selectedSuggestionIndex = (selectedSuggestionIndex + 1) % items.length;
                items[selectedSuggestionIndex].classList.add('active');
                items[selectedSuggestionIndex].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                items[selectedSuggestionIndex].classList.remove('active');
                selectedSuggestionIndex = (selectedSuggestionIndex - 1 + items.length) % items.length;
                items[selectedSuggestionIndex].classList.add('active');
                items[selectedSuggestionIndex].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'Enter' || e.key === 'Tab') {
                e.preventDefault();
                items[selectedSuggestionIndex].click();
            } else if (e.key === 'Escape') {
                suggestionBox.style.display = 'none';
            }
        }

        function positionSuggestionBox(cursorPos) {
            // Simplified cursor positioning using mirror div
            const text = editorArea.value.substring(0, cursorPos);
            mirrorDiv.textContent = text;
            const span = document.createElement('span');
            span.textContent = '.';
            mirrorDiv.appendChild(span);
            
            const rect = span.getBoundingClientRect();
            const editorRect = editorArea.getBoundingClientRect();
            
            // Calculate relative position
            let top = rect.top - editorRect.top + 24; // 24px line height approx + padding
            let left = rect.left - editorRect.left;

            // Constrain
            if(left + 200 > editorArea.clientWidth) left = editorArea.clientWidth - 200;
            
            suggestionBox.style.top = top + 'px';
            suggestionBox.style.left = left + 'px';
        }

        // --- Globals & Core Logic (Same as before) ---
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const runBtn = document.getElementById('runBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const oled = document.getElementById('oledScreen');
        
        let isRunning = false;
        let animationFrame;
        let commandQueue = [];
        let currentCommandIndex = 0;
        let commandStartTime = 0;
        let lastTimestamp = 0;

        const WORLD_W = 2400;
        const WORLD_H = 1800;
        let camera = { x: 0, y: 0, scale: 0.5 };
        let isDragging = false;
        let lastMouse = { x: 0, y: 0 };

        const ROBOT_SIZE = 40;
        const ROBOT_COLOR = '#4F46E5'; 
        let robot = { x: 0, y: 0, angle: 0, speedL: 0, speedR: 0, servoAngle: 90, holdingObject: null };
        let currentLevel = 'lv1';
        let cans = [];
        let targetZones = []; 
        let checkpoints = []; 
        let currentCheckpointIndex = 0;

        const levelData = {
            'free': { name: "‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏¥‡∏™‡∏£‡∏∞", hint: "‡πÉ‡∏ä‡πâ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö", code: "// ‡∏•‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏•‡πà‡∏ô‡πÜ ‡∏î‡∏π‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö\nFD(50);\ndelay(1000);\nAO();" },
            'lv1': { name: "‡∏î‡πà‡∏≤‡∏ô 1: ‡πÑ‡∏õ‡∏ß‡∏¥‡∏®‡∏ß‡∏∞", hint: "‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤ 3.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ -> ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢ -> ‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≠", code: "FD(50); delay(3500);\nSL(40); delay(1200);\nFD(50); delay(3000);\nAO();" },
            'lv2': { name: "‡∏î‡πà‡∏≤‡∏ô 2: ‡πÑ‡∏õ‡∏ß‡∏¥‡∏ó‡∏¢‡πå", hint: "‡∏ó‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏¢‡∏≤‡∏ß‡πÜ ‡πÄ‡∏û‡∏¥‡πà‡∏° delay ‡πÄ‡∏õ‡πá‡∏ô 5000", code: "FD(50); delay(5000);\nAO();" },
            'lv3': { name: "‡∏î‡πà‡∏≤‡∏ô 3: ‡πÑ‡∏õ‡πÅ‡∏û‡∏ó‡∏¢‡πå", hint: "‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤ -> ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢ -> ‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤", code: "FD(50); delay(2000);\nSL(50); delay(1000);\nFD(50); delay(3000);\nAO();" },
            'lv4': { name: "‡∏î‡πà‡∏≤‡∏ô 4: ‡πÑ‡∏õ‡πÄ‡∏Å‡∏©‡∏ï‡∏£", hint: "‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á SR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏Ç‡∏ß‡∏≤", code: "FD(50); delay(5000);\nSR(50); delay(1000);\nFD(50); delay(3000);\nAO();" },
            'lv5': { name: "‡∏î‡πà‡∏≤‡∏ô 5: ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏î‡πà‡∏ß‡∏ô", hint: "‡πÉ‡∏ä‡πâ servo(1,20) ‡∏´‡∏ô‡∏µ‡∏ö ‡πÅ‡∏•‡∏∞ servo(1,90) ‡∏õ‡∏•‡πà‡∏≠‡∏¢", code: "servo(1, 90);\nFD(30); delay(800); AO();\nservo(1, 20); delay(500);\nFD(50); delay(3000);\nSL(40); delay(1200);\nFD(50); delay(3000);\nAO();\nservo(1, 90);" },
            'lv6': { name: "‡∏î‡πà‡∏≤‡∏ô 6: ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á", hint: "‡∏Ñ‡∏µ‡∏ö -> ‡∏ñ‡∏≠‡∏¢ (BK) -> ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß", code: "servo(1, 90);\nFD(30); delay(800); AO();\nservo(1, 20); delay(500);\nBK(40); delay(1500);\nSL(50); delay(1000);\nFD(50); delay(3000);\nAO();" },
            'lv7': { name: "‡∏î‡πà‡∏≤‡∏ô 7: Loop", hint: "‡∏ó‡∏≥‡∏ã‡πâ‡∏≥ 4 ‡∏£‡∏≠‡∏ö: ‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤-‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß", code: "FD(50); delay(4000);\nSL(50); delay(1000);\nFD(40); delay(2000);\nSL(50); delay(1000);\nFD(50); delay(4000);\nSL(50); delay(1000);\nFD(40); delay(2000);\nAO();" },
            'lv8': { name: "‡∏î‡πà‡∏≤‡∏ô 8: Checkpoint", hint: "‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏∏‡∏î 1 ‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡∏¢", code: "FD(40); delay(1500);\nSR(50); delay(1000);\nFD(50); delay(4000);\nAO();" },
            'lv9': { name: "‡∏î‡πà‡∏≤‡∏ô 9: ‡∏ñ‡∏≠‡∏¢‡∏à‡∏≠‡∏î", hint: "‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏•‡∏≥ -> ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß -> ‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á", code: "FD(30); delay(1500);\nSL(50); delay(1000);\nBK(30); delay(3000);\nAO();" },
            'lv10': { name: "‡∏î‡πà‡∏≤‡∏ô 10: Full Mission", hint: "‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏®‡∏ß‡∏∞ -> ‡∏™‡πà‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡πå -> ‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏©‡∏ï‡∏£ -> ‡∏Å‡∏•‡∏±‡∏ö", code: `FD(50); delay(3500); SL(50); delay(800); FD(40); delay(1500); AO();\nservo(1,90); delay(500); FD(20); delay(500); AO(); servo(1,20); delay(500);\nBK(40); delay(2000); SR(50); delay(800); FD(50); delay(2000); AO();\nSL(50); delay(800); FD(30); delay(1000); AO(); servo(1,90); delay(500); BK(30); delay(1000);\nSR(50); delay(800); FD(50); delay(3000); AO();\nSL(50); delay(800); FD(30); delay(1000); AO(); servo(1,20); delay(500);\nBK(30); delay(1000); SL(50); delay(800); FD(50); delay(4000); AO(); servo(1,90);` },
            'lv11': { name: "‡∏î‡πà‡∏≤‡∏ô 11: Slalom", hint: "‡∏ã‡∏¥‡∏Å‡πÅ‡∏ã‡∏Å ‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤", code: "FD(50); delay(1000);\nSL(40); delay(500);\nFD(50); delay(1000);\nSR(40); delay(500);\nFD(50); delay(1000);\nSL(40); delay(500);\nFD(50); delay(1000);\nSR(40); delay(500);\nFD(50); delay(1500);\nAO();" },
            'lv12': { name: "‡∏î‡πà‡∏≤‡∏ô 12: U-Turn", hint: "‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß 90 ‡∏™‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á = 180", code: "FD(50); delay(2000);\nSL(60); delay(800);\nFD(30); delay(1000);\nSL(60); delay(800);\nFD(50); delay(2000);\nAO();" },
            'lv13': { name: "‡∏î‡πà‡∏≤‡∏ô 13: Figure 8", hint: "‡∏ß‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ 1 ‡∏£‡∏≠‡∏ö + ‡∏ß‡∏ô‡∏Ç‡∏ß‡∏≤ 1 ‡∏£‡∏≠‡∏ö", code: "FD(50); delay(2000);\nSL(50); delay(1200);\nFD(40); delay(1500);\nSL(50); delay(1200);\nFD(50); delay(2000);\nSR(50); delay(1200);\nFD(40); delay(1500);\nSR(50); delay(1200);\nAO();" },
            'lv14': { name: "‡∏î‡πà‡∏≤‡∏ô 14: Spiral", hint: "‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ", code: "FD(60); delay(3000); SL(50); delay(800);\nFD(50); delay(2500); SL(50); delay(800);\nFD(40); delay(2000); SL(50); delay(800);\nFD(30); delay(1500); SL(50); delay(800);\nAO();" },
            'lv15': { name: "‡∏î‡πà‡∏≤‡∏ô 15: Long Reverse", hint: "‡πÉ‡∏ä‡πâ‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏•‡∏ö motor(1,-30)", code: "BK(50); delay(4000);\nmotor(1, -30); motor(2, -60); delay(1500);\nBK(30); delay(1000);\nAO();" },
            'lv16': { name: "‡∏î‡πà‡∏≤‡∏ô 16: Multi-Drop", hint: "‡∏Ñ‡∏µ‡∏ö-‡∏ß‡∏≤‡∏á-‡πÑ‡∏õ‡∏ï‡πà‡∏≠-‡∏Ñ‡∏µ‡∏ö", code: "servo(1, 90); FD(30); delay(500); AO(); servo(1, 20); delay(500);\nFD(50); delay(2000); AO(); servo(1, 90); delay(500); BK(20); delay(500);\nSR(50); delay(800); FD(50); delay(2000); AO();\nSL(50); delay(800); FD(40); delay(1500); AO();" },
            'lv17': { name: "‡∏î‡πà‡∏≤‡∏ô 17: Perimeter", hint: "‡πÄ‡∏î‡∏¥‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡∏ô‡∏≠‡∏Å‡∏™‡∏∏‡∏î", code: "FD(80); delay(4000);\nSL(50); delay(900);\nFD(80); delay(3000);\nSL(50); delay(900);\nFD(80); delay(4000);\nSL(50); delay(900);\nFD(80); delay(3000);\nAO();" },
            'lv18': { name: "‡∏î‡πà‡∏≤‡∏ô 18: Staircase", hint: "‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ ‡∏™‡∏•‡∏±‡∏ö‡∏ü‡∏±‡∏ô‡∏õ‡∏•‡∏≤", code: "FD(40); delay(1000); SR(50); delay(800);\nFD(40); delay(1000); SL(50); delay(800);\nFD(40); delay(1000); SR(50); delay(800);\nFD(40); delay(1000); SL(50); delay(800);\nAO();" },
            'lv19': { name: "‡∏î‡πà‡∏≤‡∏ô 19: 360 Spin", hint: "‡∏•‡πâ‡∏≠‡∏´‡∏°‡∏∏‡∏ô‡∏™‡∏ß‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏±‡∏ô", code: "FD(50); delay(2000);\nmotor(1, 60); motor(2, -60); delay(2500);\nFD(50); delay(2000);\nAO();" },
            'lv20': { name: "‡∏î‡πà‡∏≤‡∏ô 20: FINAL", hint: "‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤!", code: "FD(60); delay(2000);\nSL(50); delay(800);\nFD(40); delay(1500);\nmotor(1, -40); motor(2, -20); delay(1500);\nBK(30); delay(1000);\nFD(100); delay(1500);\nAO();" }
        };

        // --- Init & Events ---
        function resizeCanvas() { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; draw(); }
        window.addEventListener('resize', resizeCanvas);
        
        function resetCamera() { 
            camera.x = WORLD_W / 2; camera.y = WORLD_H / 2; 
            const scaleX = canvas.width / (WORLD_W + 100); const scaleY = canvas.height / (WORLD_H + 100); 
            camera.scale = Math.min(scaleX, scaleY, 0.5); 
            draw(); 
        }
        function zoomIn() { camera.scale *= 1.2; draw(); }
        function zoomOut() { camera.scale /= 1.2; draw(); }
        
        // Mouse Controls
        canvas.addEventListener('mousedown', e => { isDragging = true; lastMouse = { x: e.clientX, y: e.clientY }; });
        window.addEventListener('mouseup', () => isDragging = false);
        canvas.addEventListener('mousemove', e => {
            if (isDragging) {
                const dx = e.clientX - lastMouse.x; const dy = e.clientY - lastMouse.y;
                camera.x -= dx / camera.scale; camera.y -= dy / camera.scale;
                lastMouse = { x: e.clientX, y: e.clientY }; draw();
            }
        });
        canvas.addEventListener('wheel', e => { e.preventDefault(); const newScale = camera.scale * (1 - Math.sign(e.deltaY) * 0.1); if (newScale > 0.1 && newScale < 5.0) { camera.scale = newScale; draw(); } }, { passive: false });

        // Logic
        function resetScenario() {
            robot.speedL = 0; robot.speedR = 0; robot.servoAngle = 90; robot.holdingObject = null;
            let startX = WORLD_W * 0.5, startY = WORLD_H * 0.95, startAngle = -Math.PI / 2;
            cans = []; targetZones = []; checkpoints = []; currentCheckpointIndex = 0;
            
            // Map Setup
            const w = WORLD_W, h = WORLD_H;
            const locEng = { x: w*0.15, y: h*0.2, w: w*0.2, h: h*0.2 };
            const locSci = { x: w*0.48, y: h*0.15, w: w*0.2, h: h*0.2 };
            const locMed = { x: w*0.45, y: h*0.75, w: w*0.2, h: h*0.15 };
            const locAgri = { x: w*0.82, y: h*0.2, w: w*0.2, h: h*0.2 };
            const locParking = { x: w*0.85, y: h*0.85, w: 200, h: 250 };

            switch(currentLevel) {
                case 'lv1': targetZones.push({ ...locEng, type: 'stop', active: true }); break;
                case 'lv2': targetZones.push({ ...locSci, type: 'stop', active: true }); break;
                case 'lv3': targetZones.push({ ...locMed, type: 'stop', active: true }); break;
                case 'lv4': targetZones.push({ ...locAgri, type: 'stop', active: true }); break;
                case 'lv5': cans.push({id:1, x:startX, y:startY-150, color:'orange', radius:15, grabbed:false}); targetZones.push({...locEng, type:'drop', active:true}); break;
                case 'lv6': startX=locSci.x; startY=locSci.y+150; startAngle=-Math.PI/2; cans.push({id:1, x:locSci.x, y:locSci.y, color:'#3b82f6', radius:15, grabbed:false}); targetZones.push({...locMed, type:'drop', active:true}); break;
                case 'lv7': checkpoints=[{x:w*0.2, y:h*0.45, r:100}, {x:w*0.5, y:h*0.1, r:100}, {x:w*0.8, y:h*0.45, r:100}, {x:w*0.5, y:h*0.9, r:100}]; break;
                case 'lv8': startX=locSci.x; startY=locSci.y+100; targetZones.push({...locAgri, type:'stop', active:true}); break;
                case 'lv9': startX=locAgri.x; startY=locAgri.y+200; startAngle=Math.PI/2; targetZones.push({...locParking, type:'stop', active:true}); break;
                case 'lv10': cans.push({id:1, x:locEng.x+locEng.w/2, y:locEng.y+locEng.h+50, color:'red', radius:15, grabbed:false}); cans.push({id:2, x:locAgri.x+locAgri.w/2, y:locAgri.y+locAgri.h+50, color:'green', radius:15, grabbed:false}); targetZones.push({...locParking, type:'stop', active:true}); break;
                case 'lv11': startX=w*0.25; startY=h*0.9; checkpoints=[{x:w*0.25,y:h*0.75,r:60},{x:w*0.35,y:h*0.6,r:60},{x:w*0.25,y:h*0.45,r:60},{x:w*0.35,y:h*0.3,r:60},{x:w*0.25,y:h*0.15,r:80}]; break;
                case 'lv12': startX=w*0.75; startY=h*0.8; targetZones.push({x:w*0.75, y:h*0.85, w:100, h:100, type:'stop', active:true}); break;
                case 'lv13': startX=w*0.5; startY=h*0.5; checkpoints=[{x:w*0.4,y:h*0.4,r:80},{x:w*0.6,y:h*0.4,r:80},{x:w*0.5,y:h*0.5,r:60}]; break;
                case 'lv14': startX=w*0.5; startY=h*0.5; targetZones.push({x:w*0.5, y:h*0.2, w:100, h:100, type:'stop', active:true}); break;
                case 'lv15': startX=w*0.25; startY=h*0.2; startAngle=Math.PI/2; targetZones=[{x:w*0.25, y:h*0.8, w:100, h:100, type:'stop', active:true}]; break;
                case 'lv16': cans.push({id:1,x:startX,y:startY-100,color:'red',radius:15}); cans.push({id:2,x:locSci.x,y:locSci.y+100,color:'blue',radius:15}); cans.push({id:3,x:locAgri.x,y:locAgri.y+100,color:'green',radius:15}); targetZones.push({...locMed, type:'drop', active:true}); break;
                case 'lv17': startX=w*0.1; startY=h*0.9; checkpoints=[{x:w*0.1,y:h*0.1,r:100},{x:w*0.9,y:h*0.1,r:100},{x:w*0.9,y:h*0.9,r:100},{x:w*0.1,y:h*0.9,r:100}]; break;
                case 'lv18': startX=w*0.1; startY=h*0.9; checkpoints=[{x:w*0.2,y:h*0.8,r:60},{x:w*0.3,y:h*0.7,r:60},{x:w*0.4,y:h*0.6,r:60},{x:w*0.5,y:h*0.5,r:60}]; break;
                case 'lv19': targetZones.push({x:startX, y:startY-200, w:100, h:100, type:'stop', active:true}); break;
                case 'lv20': startX=w*0.5; startY=h*0.9; cans.push({id:1,x:w*0.2,y:h*0.5,color:'red',radius:15}); cans.push({id:2,x:w*0.8,y:h*0.5,color:'blue',radius:15}); targetZones.push({x:w*0.5, y:h*0.1, w:200, h:200, type:'stop', active:true}); break;
            }

            robot.x = startX; robot.y = startY; robot.angle = startAngle;
            oled.innerText = "Ready...";
            updateDashboard(); resetCamera(); draw();
        }

        // --- Draw ---
        function draw() {
            ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width,canvas.height);
            const cx = canvas.width/2, cy = canvas.height/2;
            ctx.translate(cx, cy); ctx.scale(camera.scale, camera.scale); ctx.translate(-camera.x, -camera.y);

            drawUbonMap();
            
            checkpoints.forEach((cp, idx) => {
                ctx.beginPath(); ctx.arc(cp.x, cp.y, cp.r, 0, Math.PI*2);
                ctx.fillStyle = idx===currentCheckpointIndex ? 'rgba(239,68,68,0.4)' : 'rgba(209,213,219,0.3)';
                ctx.fill(); ctx.strokeStyle = idx===currentCheckpointIndex ? '#ef4444' : '#9ca3af'; ctx.stroke();
                ctx.fillStyle = '#000'; ctx.font='bold 30px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(idx+1, cp.x, cp.y);
            });

            targetZones.forEach(z => {
                if(!z.active) return;
                const pulse = Math.sin(Date.now()/200)*0.2 + 0.4;
                ctx.fillStyle = z.type==='drop' ? `rgba(16,185,129,${pulse})` : `rgba(239,68,68,${pulse})`;
                ctx.fillRect(z.x-z.w/2, z.y-z.h/2, z.w, z.h);
                ctx.fillStyle='#000'; ctx.font="bold 30px Prompt"; ctx.textAlign="center"; ctx.fillText(z.type==='drop'?"‡∏à‡∏∏‡∏î‡∏ß‡∏≤‡∏á":"‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢", z.x, z.y);
            });

            cans.forEach(c => { if(!c.grabbed) drawCan(c.x, c.y, c.color, c.radius); });
            drawRobot();
        }

        function drawUbonMap() {
            const w=WORLD_W, h=WORLD_H;
            ctx.fillStyle='#f8fafc'; ctx.fillRect(0,0,w,h); ctx.strokeStyle='#94a3b8'; ctx.lineWidth=10; ctx.strokeRect(0,0,w,h);
            ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=80; ctx.strokeStyle='#334155';
            ctx.beginPath();
            ctx.moveTo(w*0.25, h*0.2); ctx.lineTo(w*0.25, h*0.8); ctx.lineTo(w*0.75, h*0.8); ctx.lineTo(w*0.75, h*0.2); ctx.lineTo(w*0.25, h*0.2);
            ctx.moveTo(w*0.25, h*0.5); ctx.lineTo(w*0.75, h*0.5); ctx.moveTo(w*0.5, h*0.2); ctx.lineTo(w*0.5, h*0.5); ctx.moveTo(w*0.5, h*0.8); ctx.lineTo(w*0.5, h*0.95);
            ctx.stroke();
            ctx.lineWidth=4; ctx.strokeStyle='#ffffff'; ctx.setLineDash([20,30]); ctx.stroke(); ctx.setLineDash([]);
            
            drawBuilding(w*0.1, h*0.1, w*0.2, h*0.3, '#fca5a5', '‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå');
            drawBuilding(w*0.4, h*0.05, w*0.2, h*0.25, '#fde047', '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå');
            drawBuilding(w*0.7, h*0.1, w*0.2, h*0.3, '#86efac', '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå');
            drawBuilding(w*0.35, h*0.6, w*0.3, h*0.15, '#93c5fd', '‡πÅ‡∏û‡∏ó‡∏¢‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå');
            
            ctx.fillStyle='rgba(59,130,246,0.3)'; ctx.fillRect(w*0.45, h*0.9, w*0.1, h*0.1);
            ctx.fillStyle='#1e3a8a'; ctx.font="bold 32px Prompt"; ctx.textAlign="center"; ctx.fillText("START", w*0.5, h*0.95);
        }

        function drawBuilding(x,y,w,h,c,l) { ctx.fillStyle=c; ctx.fillRect(x,y,w,h); ctx.strokeStyle='rgba(0,0,0,0.1)'; ctx.lineWidth=2; ctx.strokeRect(x,y,w,h); ctx.fillStyle='#374151'; ctx.font='bold 24px Prompt'; ctx.fillText(l, x+w/2, y+h/2); }
        function drawCan(x,y,c,r) { ctx.fillStyle=c; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.fillStyle='rgba(255,255,255,0.8)'; ctx.beginPath(); ctx.arc(x-r/3, y-r/3, r/4, 0, Math.PI*2); ctx.fill(); }
        
        function drawRobot() {
            ctx.save(); ctx.translate(robot.x, robot.y); ctx.rotate(robot.angle);
            const va = (robot.servoAngle/90)*(Math.PI/4);
            ctx.strokeStyle='#4b5563'; ctx.lineWidth=6; ctx.beginPath(); ctx.moveTo(15,-10); ctx.lineTo(15+20*Math.cos(va), -10-20*Math.sin(va)); ctx.stroke(); ctx.beginPath(); ctx.moveTo(15,10); ctx.lineTo(15+20*Math.cos(va), 10+20*Math.sin(va)); ctx.stroke();
            if(robot.holdingObject) drawCan(25, 0, robot.holdingObject.color, robot.holdingObject.radius);
            ctx.fillStyle=ROBOT_COLOR; ctx.beginPath(); ctx.roundRect(-20,-20,40,40,8); ctx.fill();
            ctx.fillStyle='#111827'; ctx.fillRect(-10,-25,20,5); ctx.fillRect(-10,20,20,5);
            ctx.fillStyle='#FCD34D'; ctx.beginPath(); ctx.moveTo(10,0); ctx.lineTo(-5,-6); ctx.lineTo(-5,6); ctx.fill();
            ctx.restore();
        }

        // --- Physics & Run ---
        function updatePhysics(dt) {
            const sm = 3.5;
            let v = (robot.speedL+robot.speedR)*sm/2;
            let rot = (robot.speedR-robot.speedL)/40*0.8;
            robot.x += Math.cos(robot.angle)*v*dt; robot.y += Math.sin(robot.angle)*v*dt; robot.angle += rot*dt;
            if(robot.x<0) robot.x=0; if(robot.x>WORLD_W) robot.x=WORLD_W; if(robot.y<0) robot.y=0; if(robot.y>WORLD_H) robot.y=WORLD_H;
            checkMission();
        }

        function attemptGrab() {
            const reach=50, gx=robot.x+Math.cos(robot.angle)*30, gy=robot.y+Math.sin(robot.angle)*30;
            let grabbed=null; cans.forEach(c=>{ if(!c.grabbed && Math.hypot(c.x-gx, c.y-gy)<reach) grabbed=c; });
            if(grabbed) { grabbed.grabbed=true; robot.holdingObject=grabbed; playTone(1000,100); }
        }
        function attemptDrop() { if(robot.holdingObject) { robot.holdingObject.grabbed=false; robot.holdingObject.x=robot.x+Math.cos(robot.angle)*40; robot.holdingObject.y=robot.y+Math.sin(robot.angle)*40; robot.holdingObject=null; } }
        
        function checkMission() {
            if(!isRunning) return;
            if(checkpoints.length>0) {
                if(currentCheckpointIndex<checkpoints.length) {
                    let cp=checkpoints[currentCheckpointIndex];
                    if(Math.hypot(robot.x-cp.x, robot.y-cp.y) < cp.r) { currentCheckpointIndex++; playTone(600,100); if(currentCheckpointIndex>=checkpoints.length) showSuccess(); }
                } return;
            }
            targetZones.forEach(z => {
                if(!z.active) return;
                let inZone = (robot.x > z.x-z.w/2 && robot.x < z.x+z.w/2 && robot.y > z.y-z.h/2 && robot.y < z.y+z.h/2);
                if(inZone) {
                    if(z.type==='stop' && Math.abs(robot.speedL)<5 && Math.abs(robot.speedR)<5) showSuccess();
                    else if(z.type==='drop') { let itemIn=false; cans.forEach(c=>{ if(!c.grabbed && c.x>z.x-z.w/2 && c.x<z.x+z.w/2 && c.y>z.y-z.h/2 && c.y<z.y+z.h/2) itemIn=true; }); if(itemIn) showSuccess(); }
                }
            });
        }

        function showSuccess() { isRunning=false; document.getElementById('successOverlay').classList.remove('hidden'); document.getElementById('successOverlay').classList.add('flex'); playTone(800,100); setTimeout(()=>playTone(1200,300),150); }
        function closeSuccess() { document.getElementById('successOverlay').classList.add('hidden'); document.getElementById('successOverlay').classList.remove('flex'); }
        function nextLevel() { closeSuccess(); let s=document.getElementById('missionSelect'); if(s.selectedIndex<s.options.length-1) { s.selectedIndex++; s.dispatchEvent(new Event('change')); } }

        function parseCode(src) {
            const lines=src.split('\n'), cmds=[];
            lines.forEach((l,i) => {
                l=l.split('//')[0].trim(); if(!l || l.startsWith('#') || l.startsWith('void') || l==='{' || l==='}') return;
                let m=l.match(/([a-zA-Z0-9_.]+)\((.*)\);?/);
                if(m) {
                    let c=m[1].toLowerCase(), args=[];
                    if(m[2].includes('"')) { let sm=m[2].match(/"([^"]+)"/); if(sm) args.push(sm[1]); let nm=m[2].split(',')[0].trim(); if(!isNaN(nm)) args.unshift(parseInt(nm)); }
                    else args=m[2].split(',').map(s=>parseFloat(s.trim()));
                    if(c==='delay') c='sleep';
                    cmds.push({type:c, args:args, line:i+1});
                }
            });
            cmds.push({type:'ao', args:[]}); return cmds;
        }

        function runSimulation() {
            if(isRunning) return;
            commandQueue = parseCode(editor.value);
            if(commandQueue.length===0) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î"); return; }
            isRunning=true; currentCommandIndex=0; commandStartTime=0; lastTimestamp=performance.now();
            runBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Running...'; runBtn.classList.add('bg-orange-500'); statusIndicator.innerHTML='<span class="text-green-500">Running</span>';
            requestAnimationFrame(gameLoop);
        }

        function resetSimulation() { isRunning=false; cancelAnimationFrame(animationFrame); resetScenario(); runBtn.innerHTML='<i class="fas fa-play"></i> Upload & Run'; runBtn.classList.remove('bg-orange-500'); statusIndicator.innerHTML='<span class="text-yellow-500">Ready</span>'; }

        function gameLoop(ts) {
            if(!isRunning) return;
            const dt=(ts-lastTimestamp)/1000; lastTimestamp=ts;
            if(currentCommandIndex<commandQueue.length) {
                const cmd=commandQueue[currentCommandIndex];
                if(commandStartTime===0) { commandStartTime=ts; executeCommand(cmd); }
                if(cmd.type==='sleep') { if(ts-commandStartTime >= cmd.args[0]) { currentCommandIndex++; commandStartTime=0; } }
                else { currentCommandIndex++; commandStartTime=0; }
            } else {
                isRunning=false; robot.speedL=0; robot.speedR=0; updateDashboard();
                runBtn.innerHTML='<i class="fas fa-check"></i> Done'; setTimeout(()=>resetSimulation(),1500);
            }
            updatePhysics(dt); draw();
            if(isRunning) animationFrame=requestAnimationFrame(gameLoop);
        }

        function executeCommand(cmd) {
            switch(cmd.type) {
                case 'fd': robot.speedL=cmd.args[0]; robot.speedR=cmd.args[0]; break;
                case 'bk': robot.speedL=-cmd.args[0]; robot.speedR=-cmd.args[0]; break;
                case 'sl': robot.speedL=-cmd.args[0]; robot.speedR=cmd.args[0]; break;
                case 'sr': robot.speedL=cmd.args[0]; robot.speedR=-cmd.args[0]; break;
                case 'ao': robot.speedL=0; robot.speedR=0; break;
                case 'motor': if(cmd.args[0]===1) robot.speedL=cmd.args[1]; if(cmd.args[0]===2) robot.speedR=cmd.args[1]; break;
                case 'servo': setGripper(cmd.args[1]!==undefined?cmd.args[1]:cmd.args[0]); break;
                case 'oled.text': if(cmd.args[0]===0) oled.innerText=cmd.args[2]; else oled.innerText+="\n"+cmd.args[2]; break;
            }
            updateDashboard();
        }

        function updateDashboard() { motorLDisp.innerText=Math.round(robot.speedL); motorRDisp.innerText=Math.round(robot.speedR); servoDisp.innerText=robot.servoAngle+"¬∞"; }
        function playTone(f,d) { const ac=new(window.AudioContext||window.webkitAudioContext)(); const o=ac.createOscillator(); const g=ac.createGain(); o.type='square'; o.frequency.value=f; g.gain.value=0.05; o.connect(g); g.connect(ac.destination); o.start(); setTimeout(()=>o.stop(),d); }

        const mSel=document.getElementById('missionSelect'), mBox=document.getElementById('missionBox'), mTxt=document.getElementById('missionText');
        mSel.addEventListener('change', e=>{ currentLevel=e.target.value; setMissionUI(currentLevel); resetSimulation(); });

        function openAI() { document.getElementById('aiModal').classList.remove('hidden'); document.getElementById('aiChatContent').innerHTML=`<p class="text-gray-700 bg-white p-3 rounded-lg shadow-sm border border-gray-200">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡πà‡∏≤‡∏ô <strong>${levelData[currentLevel]?.name || '‡∏ô‡∏µ‡πâ'}</strong> ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?</p>`; }
        function closeAI() { document.getElementById('aiModal').classList.add('hidden'); }
        function addAiMessage(t,u) { const d=document.createElement('div'); d.className=u?"bg-indigo-100 text-indigo-900 p-3 rounded-lg self-end text-right":"bg-white text-gray-700 p-3 rounded-lg shadow-sm border border-gray-200"; d.innerHTML=t; document.getElementById('aiChatContent').appendChild(d); }
        function aiGetHint() { addAiMessage("‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢",true); setTimeout(()=>addAiMessage(`üí° <strong>‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ:</strong> ${levelData[currentLevel]?.hint || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ'}`),500); }
        function aiCheckCode() { addAiMessage("‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢",true); let c=editor.value, a="‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡∏π‡πÇ‡∏≠‡πÄ‡∏Ñ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏•‡∏≠‡∏á‡∏£‡∏±‡∏ô‡∏î‡∏π‡πÄ‡∏•‡∏¢!"; if(!c.includes("AO()")) a="‚ö†Ô∏è ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏™‡∏±‡πà‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå (AO) ‡∏ï‡∏≠‡∏ô‡∏à‡∏ö‡∏ô‡∏∞!"; else if(!c.includes("delay")) a="‚ö†Ô∏è ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà delay ‡πÉ‡∏´‡πâ‡∏´‡∏∏‡πà‡∏ô‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ô‡∏∞"; setTimeout(()=>addAiMessage(`üßê ${a}`),600); }
        function aiRevealSolution() { if(confirm("‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏≠‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢?")) { addAiMessage("‡∏Ç‡∏≠‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢",true); setTimeout(()=>{ addAiMessage("üîì ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏•‡∏¢‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö"); editor.value=`#include <POP32.h>\n\nvoid setup() {\n  oled.text(0,0,"Solution");\n}\n\nvoid loop() {\n${levelData[currentLevel]?.code || ''}\n}`; closeAI(); },800); } }

        function setMissionUI(l) { mBox.classList.remove('hidden'); mBox.classList.add('flex'); mTxt.innerText=levelData[l]?.name; editor.value=`#include <POP32.h>\n\nvoid setup() {\n  oled.text(0, 0, "Mission Start");\n}\n\nvoid loop() {\n  // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà\n  \n}`; }

        // Start
        resizeCanvas(); setMissionUI('lv1');
    </script>
</body>
</html>
